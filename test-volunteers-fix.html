<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Volunteers Fix</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .test-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-buttons { margin: 10px 0; }
        .test-buttons button { margin: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Volunteers Loading Fix</h1>
        
        <div class="test-section">
            <h2>1. System Status</h2>
            <div class="test-buttons">
                <button onclick="checkSystemStatus()">Check System Status</button>
                <button onclick="checkVolunteerData()">Check Volunteer Data</button>
            </div>
            <div id="systemStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>2. Volunteers Grid Test</h2>
            <div class="test-buttons">
                <button onclick="testVolunteersGrid()">Test Volunteers Grid</button>
                <button onclick="manualFixVolunteers()">Manual Fix</button>
                <button onclick="clearVolunteersGrid()">Clear Grid</button>
            </div>
            
            <!-- Mock volunteers grid for testing -->
            <div class="volunteers-grid" id="volunteersGrid">
                <p>Loading volunteers...</p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>3. Navigation Test</h2>
            <div class="test-buttons">
                <button onclick="simulateVolunteersNavigation()">Simulate Navigation to Volunteers</button>
                <button onclick="testSwitchView()">Test Switch View</button>
            </div>
            <div id="navigationStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>4. Quick Actions</h2>
            <div class="test-buttons">
                <button onclick="addTestVolunteer()">Add Test Volunteer</button>
                <button onclick="clearTestData()">Clear Test Data</button>
                <button onclick="window.location.href='index.html'">Go to Main App</button>
            </div>
            <div id="quickActionsStatus"></div>
        </div>
    </div>

    <!-- Include necessary scripts -->
    <script src="js/environment-manager.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/google-sheets.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/connectivity-validator.js"></script>
    <script src="js/scanner.js"></script>
    <script src="js/app.js"></script>
    <script src="fix-volunteers-loading.js"></script>

    <script>
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }

        async function checkSystemStatus() {
            let status = '';
            
            // Check StorageManager
            if (window.StorageManager && window.StorageManager.db) {
                status += '‚úÖ StorageManager: Ready<br>';
            } else {
                status += '‚ùå StorageManager: Not ready<br>';
            }
            
            // Check App
            if (window.app) {
                status += `‚úÖ App: Available (initialized: ${window.app.isInitialized})<br>`;
            } else {
                status += '‚ùå App: Not available<br>';
            }
            
            // Check Fix
            if (window.fixVolunteersLoading) {
                status += '‚úÖ Volunteers Fix: Loaded<br>';
            } else {
                status += '‚ùå Volunteers Fix: Not loaded<br>';
            }
            
            showStatus('systemStatus', status, 'info');
        }

        async function checkVolunteerData() {
            try {
                if (!window.StorageManager) {
                    showStatus('systemStatus', '‚ùå StorageManager not available', 'error');
                    return;
                }
                
                const volunteers = await window.StorageManager.getAllVolunteers();
                const count = volunteers ? volunteers.length : 0;
                
                showStatus('systemStatus', `üìä Found ${count} volunteers in database`, 'success');
                
                if (count > 0) {
                    console.log('Sample volunteers:', volunteers.slice(0, 3));
                }
                
            } catch (error) {
                showStatus('systemStatus', `‚ùå Error getting volunteers: ${error.message}`, 'error');
            }
        }

        async function testVolunteersGrid() {
            try {
                const volunteersGrid = document.getElementById('volunteersGrid');
                if (!volunteersGrid) {
                    showStatus('systemStatus', '‚ùå volunteersGrid element not found', 'error');
                    return;
                }
                
                // Test the fix function
                if (window.fixVolunteersLoading) {
                    await window.fixVolunteersLoading();
                    showStatus('systemStatus', '‚úÖ Volunteers grid test completed', 'success');
                } else {
                    showStatus('systemStatus', '‚ùå Fix function not available', 'error');
                }
                
            } catch (error) {
                showStatus('systemStatus', `‚ùå Error testing grid: ${error.message}`, 'error');
            }
        }

        function manualFixVolunteers() {
            if (window.fixVolunteersLoading) {
                window.fixVolunteersLoading();
                showStatus('systemStatus', 'üîß Manual fix applied', 'info');
            } else {
                showStatus('systemStatus', '‚ùå Manual fix not available', 'error');
            }
        }

        function clearVolunteersGrid() {
            const volunteersGrid = document.getElementById('volunteersGrid');
            if (volunteersGrid) {
                volunteersGrid.innerHTML = '<p>Loading volunteers...</p>';
                showStatus('systemStatus', 'üßπ Grid cleared', 'info');
            }
        }

        function simulateVolunteersNavigation() {
            if (window.app && window.app.switchView) {
                window.app.switchView('volunteers');
                showStatus('navigationStatus', 'üîÑ Simulated navigation to volunteers view', 'info');
            } else {
                showStatus('navigationStatus', '‚ùå App switchView not available', 'error');
            }
        }

        function testSwitchView() {
            if (window.app) {
                // Test switching to different views
                setTimeout(() => window.app.switchView('dashboard'), 100);
                setTimeout(() => window.app.switchView('volunteers'), 500);
                showStatus('navigationStatus', 'üîÑ Testing view switching...', 'info');
            } else {
                showStatus('navigationStatus', '‚ùå App not available', 'error');
            }
        }

        async function addTestVolunteer() {
            try {
                if (!window.StorageManager) {
                    showStatus('quickActionsStatus', '‚ùå StorageManager not available', 'error');
                    return;
                }
                
                const testVolunteer = {
                    id: 'TEST' + Date.now(),
                    name: 'Test Volunteer ' + Math.floor(Math.random() * 100),
                    committee: 'Test Committee',
                    status: 'Active',
                    email: 'test@example.com'
                };
                
                await window.StorageManager.addVolunteer(testVolunteer);
                showStatus('quickActionsStatus', `‚úÖ Added test volunteer: ${testVolunteer.name}`, 'success');
                
                // Refresh the grid
                setTimeout(() => {
                    if (window.fixVolunteersLoading) {
                        window.fixVolunteersLoading();
                    }
                }, 500);
                
            } catch (error) {
                showStatus('quickActionsStatus', `‚ùå Error adding test volunteer: ${error.message}`, 'error');
            }
        }

        async function clearTestData() {
            try {
                if (!window.StorageManager) {
                    showStatus('quickActionsStatus', '‚ùå StorageManager not available', 'error');
                    return;
                }
                
                // Get all volunteers and remove test ones
                const volunteers = await window.StorageManager.getAllVolunteers();
                const testVolunteers = volunteers.filter(v => v.id && v.id.startsWith('TEST'));
                
                for (const volunteer of testVolunteers) {
                    await window.StorageManager.deleteVolunteer(volunteer.id);
                }
                
                showStatus('quickActionsStatus', `üßπ Removed ${testVolunteers.length} test volunteers`, 'success');
                
                // Refresh the grid
                setTimeout(() => {
                    if (window.fixVolunteersLoading) {
                        window.fixVolunteersLoading();
                    }
                }, 500);
                
            } catch (error) {
                showStatus('quickActionsStatus', `‚ùå Error clearing test data: ${error.message}`, 'error');
            }
        }

        // Auto-run basic checks when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkSystemStatus();
            }, 1000);
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey) {
                switch (e.key) {
                    case 'T':
                        testVolunteersGrid();
                        break;
                    case 'F':
                        manualFixVolunteers();
                        break;
                    case 'S':
                        checkSystemStatus();
                        break;
                }
            }
        });

        console.log('üß™ Test page loaded. Keyboard shortcuts:');
        console.log('  Ctrl+Shift+T: Test volunteers grid');
        console.log('  Ctrl+Shift+F: Manual fix');
        console.log('  Ctrl+Shift+S: Check system status');
        console.log('  Ctrl+Shift+V: Manual volunteers fix (from main fix script)');
    </script>
</body>
</html>