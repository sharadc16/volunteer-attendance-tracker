<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Management Test - Volunteer Attendance Tracker</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Event Management System Test</h1>
        <p>This page tests the event management functionality including creating, editing, and managing recurring events.</p>

        <div class="test-section">
            <h2>Test 1: Create Single Event</h2>
            <button class="btn btn-primary" onclick="testCreateSingleEvent()">Run Test</button>
            <div id="test1Result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>Test 2: Create Recurring Events (Weekly Sunday)</h2>
            <button class="btn btn-primary" onclick="testCreateRecurringEvents()">Run Test</button>
            <div id="test2Result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>Test 3: List All Events</h2>
            <button class="btn btn-primary" onclick="testListEvents()">Run Test</button>
            <div id="test3Result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>Test 4: Update Event</h2>
            <button class="btn btn-primary" onclick="testUpdateEvent()">Run Test</button>
            <div id="test4Result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>Test 5: Event Validation</h2>
            <button class="btn btn-primary" onclick="testEventValidation()">Run Test</button>
            <div id="test5Result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>Test 6: Clean Up Test Data</h2>
            <button class="btn btn-warning" onclick="cleanUpTestData()">Clean Up</button>
            <div id="cleanupResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>

    <script>
        let storageManager;

        // Initialize storage manager
        async function initializeStorage() {
            try {
                storageManager = new StorageManager();
                await new Promise(resolve => {
                    const checkReady = () => {
                        if (storageManager.db) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });
                console.log('Storage manager initialized for testing');
            } catch (error) {
                console.error('Failed to initialize storage manager:', error);
                throw error;
            }
        }

        // Test 1: Create Single Event
        async function testCreateSingleEvent() {
            const resultDiv = document.getElementById('test1Result');
            resultDiv.style.display = 'block';
            
            try {
                await initializeStorage();
                
                const eventData = {
                    eventId: 'TEST_SINGLE_001',
                    eventName: 'Test Special Event',
                    date: '2024-12-25',
                    type: 'Special',
                    status: 'Active',
                    description: 'This is a test special event'
                };

                await storageManager.addEvent(eventData);
                
                // Verify event was created
                const createdEvent = await storageManager.getEvent('TEST_SINGLE_001');
                
                if (createdEvent && createdEvent.eventName === 'Test Special Event') {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `‚úÖ SUCCESS: Single event created successfully
Event ID: ${createdEvent.eventId}
Event Name: ${createdEvent.eventName}
Date: ${createdEvent.date}
Type: ${createdEvent.type}
Status: ${createdEvent.status}`;
                } else {
                    throw new Error('Event was not created properly');
                }
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå ERROR: ${error.message}`;
            }
        }

        // Test 2: Create Recurring Events
        async function testCreateRecurringEvents() {
            const resultDiv = document.getElementById('test2Result');
            resultDiv.style.display = 'block';
            
            try {
                await initializeStorage();
                
                // Create recurring events for next 4 weeks
                const startDate = new Date('2024-01-07'); // A Sunday
                const events = [];
                
                for (let i = 0; i < 4; i++) {
                    const eventDate = new Date(startDate);
                    eventDate.setDate(startDate.getDate() + (i * 7));
                    
                    const eventId = `TEST_REC_${eventDate.getFullYear()}${String(eventDate.getMonth() + 1).padStart(2, '0')}${String(eventDate.getDate()).padStart(2, '0')}`;
                    
                    const eventData = {
                        eventId: eventId,
                        eventName: 'Test Sunday Service',
                        date: eventDate.toISOString().split('T')[0],
                        type: 'Recurring',
                        status: 'Active',
                        recurringPattern: 'Weekly',
                        dayOfWeek: 'Sunday',
                        description: 'Test recurring Sunday service'
                    };
                    
                    await storageManager.addEvent(eventData);
                    events.push(eventData);
                }
                
                // Verify events were created
                const allEvents = await storageManager.getAllEvents();
                const testRecurringEvents = allEvents.filter(e => e.eventId.startsWith('TEST_REC_'));
                
                if (testRecurringEvents.length === 4) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `‚úÖ SUCCESS: ${testRecurringEvents.length} recurring events created
${testRecurringEvents.map(e => `- ${e.eventName} on ${e.date} (${e.dayOfWeek})`).join('\n')}`;
                } else {
                    throw new Error(`Expected 4 events, but found ${testRecurringEvents.length}`);
                }
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå ERROR: ${error.message}`;
            }
        }

        // Test 3: List All Events
        async function testListEvents() {
            const resultDiv = document.getElementById('test3Result');
            resultDiv.style.display = 'block';
            
            try {
                await initializeStorage();
                
                const allEvents = await storageManager.getAllEvents();
                const testEvents = allEvents.filter(e => e.eventId.startsWith('TEST_'));
                
                resultDiv.className = 'test-result info';
                resultDiv.textContent = `üìã Found ${testEvents.length} test events:
${testEvents.map(e => `- ${e.eventName} (${e.eventId}) - ${e.date} - ${e.type} - ${e.status}`).join('\n')}

Total events in database: ${allEvents.length}`;
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå ERROR: ${error.message}`;
            }
        }

        // Test 4: Update Event
        async function testUpdateEvent() {
            const resultDiv = document.getElementById('test4Result');
            resultDiv.style.display = 'block';
            
            try {
                await initializeStorage();
                
                // Update the single event we created
                const updatedEventData = {
                    eventId: 'TEST_SINGLE_001',
                    eventName: 'Updated Test Special Event',
                    date: '2024-12-25',
                    type: 'Special',
                    status: 'Inactive',
                    description: 'This event has been updated for testing'
                };

                await storageManager.updateEvent(updatedEventData);
                
                // Verify event was updated
                const updatedEvent = await storageManager.getEvent('TEST_SINGLE_001');
                
                if (updatedEvent && updatedEvent.eventName === 'Updated Test Special Event' && updatedEvent.status === 'Inactive') {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `‚úÖ SUCCESS: Event updated successfully
Event ID: ${updatedEvent.eventId}
New Name: ${updatedEvent.eventName}
New Status: ${updatedEvent.status}
New Description: ${updatedEvent.description}`;
                } else {
                    throw new Error('Event was not updated properly');
                }
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå ERROR: ${error.message}`;
            }
        }

        // Test 5: Event Validation
        async function testEventValidation() {
            const resultDiv = document.getElementById('test5Result');
            resultDiv.style.display = 'block';
            
            try {
                await initializeStorage();
                
                const validationTests = [];
                
                // Test 1: Missing event name
                try {
                    await storageManager.addEvent({
                        eventId: 'TEST_INVALID_001',
                        eventName: '',
                        date: '2024-01-01',
                        type: 'Special'
                    });
                    validationTests.push('‚ùå Should have failed for empty event name');
                } catch (error) {
                    validationTests.push('‚úÖ Correctly rejected empty event name');
                }
                
                // Test 2: Invalid date
                try {
                    await storageManager.addEvent({
                        eventId: 'TEST_INVALID_002',
                        eventName: 'Test Event',
                        date: 'invalid-date',
                        type: 'Special'
                    });
                    validationTests.push('‚ùå Should have failed for invalid date');
                } catch (error) {
                    validationTests.push('‚úÖ Correctly rejected invalid date');
                }
                
                // Test 3: Invalid event type
                try {
                    await storageManager.addEvent({
                        eventId: 'TEST_INVALID_003',
                        eventName: 'Test Event',
                        date: '2024-01-01',
                        type: 'InvalidType'
                    });
                    validationTests.push('‚ùå Should have failed for invalid event type');
                } catch (error) {
                    validationTests.push('‚úÖ Correctly rejected invalid event type');
                }
                
                // Test 4: Duplicate event ID
                try {
                    await storageManager.addEvent({
                        eventId: 'TEST_SINGLE_001', // This should already exist
                        eventName: 'Duplicate Event',
                        date: '2024-01-01',
                        type: 'Special'
                    });
                    validationTests.push('‚ùå Should have failed for duplicate event ID');
                } catch (error) {
                    validationTests.push('‚úÖ Correctly rejected duplicate event ID');
                }
                
                resultDiv.className = 'test-result info';
                resultDiv.textContent = `üß™ Validation Tests Results:
${validationTests.join('\n')}`;
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå ERROR: ${error.message}`;
            }
        }

        // Clean up test data
        async function cleanUpTestData() {
            const resultDiv = document.getElementById('cleanupResult');
            resultDiv.style.display = 'block';
            
            try {
                await initializeStorage();
                
                const allEvents = await storageManager.getAllEvents();
                const testEvents = allEvents.filter(e => e.eventId.startsWith('TEST_'));
                
                let deletedCount = 0;
                for (const event of testEvents) {
                    try {
                        await storageManager.deleteEvent(event.eventId);
                        deletedCount++;
                    } catch (error) {
                        console.warn(`Failed to delete event ${event.eventId}:`, error);
                    }
                }
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = `üßπ CLEANUP COMPLETE: Deleted ${deletedCount} test events
${testEvents.map(e => `- Deleted: ${e.eventName} (${e.eventId})`).join('\n')}`;
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå ERROR: ${error.message}`;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializeStorage();
                console.log('Event management test page ready');
            } catch (error) {
                console.error('Failed to initialize test page:', error);
            }
        });
    </script>
</body>
</html>