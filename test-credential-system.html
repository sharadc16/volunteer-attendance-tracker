<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Credential System</title>
    <link rel="stylesheet" href="css/credential-manager.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ready { background: #28a745; }
        .status-pending { background: #ffc107; }
        .status-error { background: #dc3545; }
    </style>
</head>
<body>
    <h1>🔐 Credential System Test</h1>
    
    <div class="test-container">
        <h2>System Status</h2>
        <div id="systemStatus">
            <p><span class="status-indicator status-pending"></span>Checking system components...</p>
        </div>
    </div>

    <div class="test-container">
        <h2>🧪 Test Credential Manager</h2>
        <p>Test the secure credential storage and management system.</p>
        
        <div class="test-buttons">
            <button class="test-button" onclick="openCredentialManager()">🔐 Open Credential Manager</button>
            <button class="test-button" onclick="testSecureStorage()">🔒 Test Secure Storage</button>
            <button class="test-button" onclick="testAPIIntegration()">🌐 Test API Integration</button>
            <button class="test-button" onclick="clearTestData()">🗑️ Clear Test Data</button>
        </div>
        
        <div id="testResults"></div>
    </div>

    <div class="test-container">
        <h2>📋 Quick Setup Guide</h2>
        <ol>
            <li><strong>Click "Open Credential Manager"</strong> to test the UI</li>
            <li><strong>Create a master password</strong> (use "test123" for testing)</li>
            <li><strong>Add test credentials:</strong>
                <ul>
                    <li>Key: <code>google_sheets_api_key</code>, Value: <code>test_api_key_123</code></li>
                    <li>Key: <code>volunteer_spreadsheet_id</code>, Value: <code>test_spreadsheet_456</code></li>
                </ul>
            </li>
            <li><strong>Test API integration</strong> to verify credentials are retrieved</li>
        </ol>
    </div>

    <div class="test-container">
        <h2>🔍 Browser Console Tests</h2>
        <p>Open browser console (F12) and run these commands:</p>
        <div class="test-result">
// Test secure storage directly
await window.secureStorage.initialize('test123');
await window.secureStorage.storeCredential('test_key', 'test_value');
const value = await window.secureStorage.getCredential('test_key');
console.log('Retrieved value:', value);

// Test credential manager
window.credentialManager.openModal();

// Test API integration
const apiKey = await window.apiManager.getAPICredential('google_sheets_api_key');
console.log('API Key:', apiKey);
        </div>
    </div>

    <!-- Include the credential system scripts -->
    <script src="js/secure-storage.js"></script>
    <script src="js/credential-manager.js"></script>
    <script src="js/api-integration.js"></script>

    <script>
        // Test functions
        function addTestResult(message, isSuccess = true) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
        }

        function openCredentialManager() {
            if (window.credentialManager) {
                window.credentialManager.openModal();
                addTestResult('✅ Credential Manager opened successfully');
            } else {
                addTestResult('❌ Credential Manager not available', false);
            }
        }

        async function testSecureStorage() {
            try {
                if (!window.secureStorage) {
                    throw new Error('SecureStorage not available');
                }

                // Test initialization
                const initialized = await window.secureStorage.initialize('test123');
                if (!initialized) {
                    throw new Error('Failed to initialize secure storage');
                }

                // Test store and retrieve
                await window.secureStorage.storeCredential('test_credential', 'test_value_' + Date.now());
                const retrieved = await window.secureStorage.getCredential('test_credential');
                
                if (retrieved && retrieved.includes('test_value_')) {
                    addTestResult('✅ Secure storage working: stored and retrieved credential');
                } else {
                    throw new Error('Failed to retrieve stored credential');
                }

                // Test list credentials
                const credentials = window.secureStorage.listCredentials();
                addTestResult(`✅ Found ${credentials.length} stored credentials: ${credentials.join(', ')}`);

            } catch (error) {
                addTestResult(`❌ Secure storage test failed: ${error.message}`, false);
            }
        }

        async function testAPIIntegration() {
            try {
                if (!window.apiManager) {
                    throw new Error('API Manager not available');
                }

                // Test getting a credential (will prompt if not set)
                const testKey = await window.apiManager.getAPICredential('test_api_key', 'TEST_FALLBACK');
                
                if (testKey) {
                    addTestResult(`✅ API Integration working: retrieved credential`);
                } else {
                    addTestResult('ℹ️ No credential set - this is expected for first run');
                }

                // Test API call structure (without actual API)
                addTestResult('✅ API Manager loaded and ready for use');

            } catch (error) {
                addTestResult(`❌ API integration test failed: ${error.message}`, false);
            }
        }

        function clearTestData() {
            try {
                if (window.secureStorage) {
                    window.secureStorage.clearAll();
                }
                localStorage.removeItem('vat_secure_credentials');
                addTestResult('✅ Test data cleared');
            } catch (error) {
                addTestResult(`❌ Failed to clear test data: ${error.message}`, false);
            }
        }

        // System status check
        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            const components = [
                { name: 'Secure Storage', obj: window.secureStorage },
                { name: 'Credential Manager', obj: window.credentialManager },
                { name: 'API Manager', obj: window.apiManager },
                { name: 'Crypto API', obj: window.crypto && window.crypto.subtle }
            ];

            let allReady = true;
            let statusHTML = '';

            components.forEach(comp => {
                const isReady = !!comp.obj;
                const statusClass = isReady ? 'status-ready' : 'status-error';
                const statusIcon = isReady ? '✅' : '❌';
                
                statusHTML += `<p><span class="status-indicator ${statusClass}"></span>${statusIcon} ${comp.name}</p>`;
                
                if (!isReady) allReady = false;
            });

            if (allReady) {
                statusHTML += '<p><strong>🎉 All systems ready! You can test the credential manager.</strong></p>';
            } else {
                statusHTML += '<p><strong>⚠️ Some components not loaded. Check browser console for errors.</strong></p>';
            }

            statusDiv.innerHTML = statusHTML;
        }

        // Check status when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkSystemStatus, 500); // Give scripts time to load
        });

        // Add keyboard shortcut for quick testing
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                openCredentialManager();
            }
        });

        console.log('🔐 Credential System Test Page Loaded');
        console.log('💡 Press Ctrl+Shift+C to open credential manager');
        console.log('💡 Check the test buttons above to verify functionality');
    </script>
</body>
</html>