<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug App Loading Issues</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button { margin: 10px; padding: 10px 20px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üîç Debug App Loading Issues</h1>
    
    <div id="results"></div>
    
    <div class="section">
        <h3>Quick Actions</h3>
        <button onclick="runFullDiagnostic()">üöÄ Run Full Diagnostic</button>
        <button onclick="checkScriptLoading()">üìú Check Script Loading</button>
        <button onclick="checkDOMElements()">üèóÔ∏è Check DOM Elements</button>
        <button onclick="checkConsoleErrors()">‚ö†Ô∏è Check Console Errors</button>
        <button onclick="openMainApp()">üè† Open Main App</button>
    </div>
    
    <script>
        let errorLog = [];
        let loadedScripts = [];
        
        // Capture all console messages
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            errorLog.push({
                type: 'error',
                timestamp: new Date().toISOString(),
                message: args.join(' '),
                stack: new Error().stack
            });
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            errorLog.push({
                type: 'warning',
                timestamp: new Date().toISOString(),
                message: args.join(' ')
            });
            originalWarn.apply(console, args);
        };
        
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function runFullDiagnostic() {
            addResult('üöÄ Starting comprehensive app loading diagnostic...', 'info');
            
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            
            checkScriptLoading();
            setTimeout(() => checkDOMElements(), 500);
            setTimeout(() => checkGlobalObjects(), 1000);
            setTimeout(() => checkConsoleErrors(), 1500);
            setTimeout(() => checkAppInitialization(), 2000);
        }
        
        function checkScriptLoading() {
            addResult('üìú Checking script loading...', 'info');
            
            const expectedScripts = [
                'js/utils.js',
                'js/storage.js',
                'js/google-sheets.js',
                'js/scanner.js',
                'js/app.js'
            ];
            
            const loadedScripts = Array.from(document.scripts).map(script => {
                const src = script.src;
                if (src) {
                    return src.split('/').pop() || src;
                }
                return 'inline script';
            });
            
            addResult(`Found ${loadedScripts.length} script tags`, 'info');
            
            expectedScripts.forEach(expectedScript => {
                const scriptName = expectedScript.split('/').pop();
                const isLoaded = loadedScripts.some(loaded => loaded.includes(scriptName));
                
                if (isLoaded) {
                    addResult(`‚úÖ ${expectedScript} - loaded`, 'success');
                } else {
                    addResult(`‚ùå ${expectedScript} - NOT loaded`, 'error');
                }
            });
            
            // Check for script errors
            const scripts = document.querySelectorAll('script[src]');
            let scriptsChecked = 0;
            
            scripts.forEach(script => {
                script.addEventListener('error', (e) => {
                    addResult(`‚ùå Script failed to load: ${script.src}`, 'error');
                });
                
                script.addEventListener('load', (e) => {
                    addResult(`‚úÖ Script loaded: ${script.src.split('/').pop()}`, 'success');
                });
                
                scriptsChecked++;
            });
            
            addResult(`Monitoring ${scriptsChecked} external scripts for load/error events`, 'info');
        }
        
        function checkDOMElements() {
            addResult('üèóÔ∏è Checking DOM elements...', 'info');
            
            const criticalElements = [
                'addEventBtn',
                'modalOverlay',
                'modalTitle',
                'modalBody',
                'modalConfirm',
                'modalCancel',
                'eventsView',
                'dashboardView'
            ];
            
            let foundElements = 0;
            
            criticalElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    addResult(`‚úÖ ${id} - found`, 'success');
                    foundElements++;
                } else {
                    addResult(`‚ùå ${id} - NOT found`, 'error');
                }
            });
            
            addResult(`Found ${foundElements}/${criticalElements.length} critical elements`, foundElements === criticalElements.length ? 'success' : 'warning');
            
            // Check if we're in the main app or a separate page
            const isMainApp = window.location.pathname === '/' || window.location.pathname.endsWith('index.html');
            addResult(`Running in main app: ${isMainApp}`, isMainApp ? 'success' : 'warning');
        }
        
        function checkGlobalObjects() {
            addResult('üåê Checking global objects...', 'info');
            
            const expectedGlobals = [
                'Utils',
                'StorageManager', 
                'GoogleSheetsService',
                'VolunteerAttendanceApp',
                'app'
            ];
            
            expectedGlobals.forEach(globalName => {
                const exists = typeof window[globalName] !== 'undefined';
                if (exists) {
                    addResult(`‚úÖ window.${globalName} - exists`, 'success');
                    
                    // Additional checks for specific objects
                    if (globalName === 'app') {
                        const app = window[globalName];
                        addResult(`   App initialized: ${app?.isInitialized || false}`, 'info');
                        addResult(`   Current view: ${app?.currentView || 'unknown'}`, 'info');
                        addResult(`   Constructor: ${app?.constructor?.name || 'unknown'}`, 'info');
                    }
                } else {
                    addResult(`‚ùå window.${globalName} - NOT found`, 'error');
                }
            });
        }
        
        function checkConsoleErrors() {
            addResult('‚ö†Ô∏è Checking console errors...', 'info');
            
            if (errorLog.length === 0) {
                addResult('‚úÖ No console errors detected', 'success');
            } else {
                addResult(`Found ${errorLog.length} console messages:`, 'warning');
                
                errorLog.forEach((error, index) => {
                    const type = error.type === 'error' ? 'error' : 'warning';
                    addResult(`${index + 1}. [${error.type.toUpperCase()}] ${error.message}`, type);
                });
            }
            
            // Check for unhandled promise rejections
            window.addEventListener('unhandledrejection', (event) => {
                addResult(`Unhandled promise rejection: ${event.reason}`, 'error');
            });
        }
        
        function checkAppInitialization() {
            addResult('üöÄ Checking app initialization...', 'info');
            
            if (typeof window.app !== 'undefined') {
                const app = window.app;
                addResult('‚úÖ App object exists', 'success');
                
                // Check initialization status
                if (app.isInitialized) {
                    addResult('‚úÖ App is initialized', 'success');
                    
                    // Test key methods
                    const methods = ['showAddEventModal', 'showModal', 'hideModal', 'switchView'];
                    methods.forEach(method => {
                        if (typeof app[method] === 'function') {
                            addResult(`‚úÖ ${method} method exists`, 'success');
                        } else {
                            addResult(`‚ùå ${method} method missing`, 'error');
                        }
                    });
                    
                } else {
                    addResult('‚ö†Ô∏è App exists but not initialized', 'warning');
                    addResult('This could mean the app is still loading...', 'info');
                }
                
            } else {
                addResult('‚ùå App object not found', 'error');
                addResult('This means the main application failed to load', 'error');
                
                // Check if we're in the right context
                if (window.opener) {
                    addResult('üîç Checking parent window for app...', 'info');
                    if (window.opener.app) {
                        addResult('‚úÖ Found app in parent window', 'success');
                    } else {
                        addResult('‚ùå No app in parent window either', 'error');
                    }
                }
            }
        }
        
        function openMainApp() {
            const mainAppUrl = window.location.origin + '/';
            addResult(`Opening main app: ${mainAppUrl}`, 'info');
            window.open(mainAppUrl, '_blank');
        }
        
        // Auto-run diagnostic when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('üîç Auto-running diagnostic...', 'info');
                runFullDiagnostic();
            }, 1000);
        });
        
        // Monitor for app loading
        let checkCount = 0;
        const maxChecks = 30; // 15 seconds
        
        const appLoadMonitor = setInterval(() => {
            checkCount++;
            
            if (typeof window.app !== 'undefined') {
                addResult('üéâ App object detected!', 'success');
                clearInterval(appLoadMonitor);
                
                if (window.app.isInitialized) {
                    addResult('üéâ App is fully initialized!', 'success');
                } else {
                    addResult('‚è≥ App detected but still initializing...', 'info');
                }
            } else if (checkCount >= maxChecks) {
                addResult('‚è∞ Stopped monitoring - app did not load within 15 seconds', 'warning');
                clearInterval(appLoadMonitor);
            }
        }, 500);
        
    </script>
</body>
</html>