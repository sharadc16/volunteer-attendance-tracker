<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Scanning Restrictions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .status-display {
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç Scanning Restrictions Test</h1>
        <p>This page tests the new scanning restrictions to ensure:</p>
        <ul>
            <li>No automatic event creation for today</li>
            <li>Scanning only allowed for predefined events</li>
            <li>Scanning restricted to 7 days after event date</li>
            <li>Proper status messages when scanning is disabled</li>
        </ul>
    </div>

    <div class="test-container">
        <h2>üìÖ Current Scanning Status</h2>
        <div id="scanningStatus" class="status-display">Loading...</div>
        <button onclick="checkScanningStatus()">Refresh Status</button>
    </div>

    <div class="test-container">
        <h2>üß™ Test Scenarios</h2>
        <button onclick="testNoEvents()">Test: No Events Scenario</button>
        <button onclick="testFutureEvent()">Test: Future Event Only</button>
        <button onclick="testExpiredEvent()">Test: Expired Event (>7 days)</button>
        <button onclick="testValidEvent()">Test: Valid Event (Within 7 days)</button>
        <button onclick="testTodayEvent()">Test: Today's Event</button>
        <div id="testResults"></div>
    </div>

    <div class="test-container">
        <h2>üìã Event Management</h2>
        <button onclick="createTestEvent(0)">Create Today's Event</button>
        <button onclick="createTestEvent(3)">Create Event 3 Days Ago</button>
        <button onclick="createTestEvent(8)">Create Event 8 Days Ago (Expired)</button>
        <button onclick="createTestEvent(-5)">Create Future Event (+5 days)</button>
        <button onclick="clearAllEvents()">Clear All Events</button>
        <div id="eventResults"></div>
    </div>

    <!-- Include required dependencies -->
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/scanner.js"></script>

    <script>
        let testScanner;

        // Initialize when page loads
        window.addEventListener('load', async () => {
            try {
                // Wait for storage manager to initialize
                await waitForStorageManager();
                
                // Initialize scanner for testing
                testScanner = new VolunteerScanner();
                
                // Check initial status
                await checkScanningStatus();
                
                showResult('info', 'Test environment initialized successfully');
            } catch (error) {
                showResult('error', `Failed to initialize: ${error.message}`);
            }
        });

        async function waitForStorageManager() {
            let attempts = 0;
            while (!window.StorageManager || !window.StorageManager.db) {
                if (attempts > 50) throw new Error('Storage manager timeout');
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
        }

        async function checkScanningStatus() {
            try {
                if (!testScanner) {
                    document.getElementById('scanningStatus').innerHTML = 
                        '<span class="error">Scanner not initialized</span>';
                    return;
                }

                const status = await testScanner.getScanningStatus();
                const statusEl = document.getElementById('scanningStatus');
                
                let statusClass = status.canScan ? 'success' : 'warning';
                let statusIcon = status.canScan ? '‚úÖ' : '‚ö†Ô∏è';
                
                statusEl.className = `status-display ${statusClass}`;
                statusEl.innerHTML = `
                    <div>${statusIcon} ${status.message}</div>
                    <div style="font-size: 0.9em; margin-top: 5px;">
                        Type: ${status.type} | Can Scan: ${status.canScan}
                    </div>
                `;

                if (status.currentEvent) {
                    statusEl.innerHTML += `
                        <div style="font-size: 0.9em; margin-top: 5px;">
                            Current Event: ${status.currentEvent.eventName} (${status.currentEvent.date})
                        </div>
                    `;
                }

            } catch (error) {
                document.getElementById('scanningStatus').innerHTML = 
                    `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function testNoEvents() {
            try {
                // Clear all events first
                await clearAllEvents();
                
                const status = await testScanner.getScanningStatus();
                
                if (!status.canScan && status.type === 'no-events') {
                    showTestResult('success', 'No Events Test: PASSED - Scanning correctly disabled when no events exist');
                } else {
                    showTestResult('error', `No Events Test: FAILED - Expected no-events type, got ${status.type}`);
                }
            } catch (error) {
                showTestResult('error', `No Events Test: ERROR - ${error.message}`);
            }
        }

        async function testFutureEvent() {
            try {
                await clearAllEvents();
                await createTestEvent(-5); // Future event
                
                const status = await testScanner.getScanningStatus();
                
                if (!status.canScan && status.type === 'future-event') {
                    showTestResult('success', 'Future Event Test: PASSED - Scanning correctly disabled for future events');
                } else {
                    showTestResult('error', `Future Event Test: FAILED - Expected future-event type, got ${status.type}`);
                }
            } catch (error) {
                showTestResult('error', `Future Event Test: ERROR - ${error.message}`);
            }
        }

        async function testExpiredEvent() {
            try {
                await clearAllEvents();
                await createTestEvent(8); // 8 days ago (expired)
                
                const status = await testScanner.getScanningStatus();
                
                if (!status.canScan && status.type === 'expired-event') {
                    showTestResult('success', 'Expired Event Test: PASSED - Scanning correctly disabled for events >7 days old');
                } else {
                    showTestResult('error', `Expired Event Test: FAILED - Expected expired-event type, got ${status.type}`);
                }
            } catch (error) {
                showTestResult('error', `Expired Event Test: ERROR - ${error.message}`);
            }
        }

        async function testValidEvent() {
            try {
                await clearAllEvents();
                await createTestEvent(3); // 3 days ago (valid)
                
                const status = await testScanner.getScanningStatus();
                
                if (status.canScan && status.type === 'active') {
                    showTestResult('success', 'Valid Event Test: PASSED - Scanning correctly enabled for events within 7 days');
                } else {
                    showTestResult('error', `Valid Event Test: FAILED - Expected active type, got ${status.type}`);
                }
            } catch (error) {
                showTestResult('error', `Valid Event Test: ERROR - ${error.message}`);
            }
        }

        async function testTodayEvent() {
            try {
                await clearAllEvents();
                await createTestEvent(0); // Today's event
                
                const status = await testScanner.getScanningStatus();
                
                if (status.canScan && status.type === 'active') {
                    showTestResult('success', 'Today Event Test: PASSED - Scanning correctly enabled for today\'s event');
                } else {
                    showTestResult('error', `Today Event Test: FAILED - Expected active type, got ${status.type}`);
                }
            } catch (error) {
                showTestResult('error', `Today Event Test: ERROR - ${error.message}`);
            }
        }

        async function createTestEvent(daysOffset) {
            try {
                const eventDate = new Date();
                eventDate.setDate(eventDate.getDate() - daysOffset);
                
                const eventId = `TEST_${Date.now()}`;
                const event = {
                    eventId: eventId,
                    eventName: `Test Event (${daysOffset === 0 ? 'Today' : daysOffset > 0 ? daysOffset + ' days ago' : Math.abs(daysOffset) + ' days future'})`,
                    date: eventDate.toISOString().split('T')[0],
                    type: 'Special',
                    status: 'Active'
                };

                await window.StorageManager.addEvent(event);
                showEventResult('success', `Created event: ${event.eventName} on ${event.date}`);
                
                // Refresh status
                await checkScanningStatus();
                
            } catch (error) {
                showEventResult('error', `Failed to create event: ${error.message}`);
            }
        }

        async function clearAllEvents() {
            try {
                await window.StorageManager.clearAllData();
                showEventResult('info', 'All events cleared');
                
                // Refresh status
                await checkScanningStatus();
                
            } catch (error) {
                showEventResult('error', `Failed to clear events: ${error.message}`);
            }
        }

        function showResult(type, message) {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showTestResult(type, message) {
            const resultsEl = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsEl.appendChild(resultDiv);
            
            // Auto-scroll to latest result
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function showEventResult(type, message) {
            const resultsEl = document.getElementById('eventResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsEl.appendChild(resultDiv);
            
            // Auto-scroll to latest result
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>