<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Environment Setup</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .setup-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .env-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .env-dev {
            border-left: 4px solid #ffc107;
            background: #fff3cd;
        }
        .env-prod {
            border-left: 4px solid #28a745;
            background: #d4edda;
        }
        .credentials-form {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .form-group small {
            color: #6c757d;
            font-size: 0.75rem;
            display: block;
            margin-top: 0.25rem;
        }
        .setup-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 0.5rem;
        }
        .setup-button:hover {
            background: #0056b3;
        }
        .setup-button.success {
            background: #28a745;
        }
        .setup-button.warning {
            background: #ffc107;
            color: #212529;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .status-configured {
            background: #28a745;
        }
        .status-not-configured {
            background: #dc3545;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <h1>üìä Google Sheets Environment Setup</h1>
        <p>Configure separate Google Sheets for development/testing and production environments.</p>

        <!-- Current Environment -->
        <div class="env-card">
            <h3>üåç Current Environment</h3>
            <div id="currentEnvironment">Loading...</div>
        </div>

        <!-- Development Environment -->
        <div class="env-card env-dev">
            <h3>üß™ Development Environment</h3>
            <p><strong>Purpose:</strong> Testing, development, and experimentation</p>
            <p><strong>Data:</strong> Test data, sample volunteers, experimental events</p>
            
            <div id="devStatus">
                <span class="status-indicator status-not-configured"></span>
                Not configured
            </div>

            <div class="credentials-form">
                <h4>Development Credentials</h4>
                <form id="devCredentialsForm">
                    <div class="form-group">
                        <label for="devApiKey">API Key:</label>
                        <input type="text" id="devApiKey" name="apiKey" placeholder="AIza...">
                        <small>Same API key can be used for both environments</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="devClientId">OAuth Client ID:</label>
                        <input type="text" id="devClientId" name="clientId" placeholder="123456789-...googleusercontent.com">
                        <small>Same client ID can be used for both environments</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="devSpreadsheetId">Development Spreadsheet ID:</label>
                        <input type="text" id="devSpreadsheetId" name="spreadsheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
                        <small><strong>‚ö†Ô∏è Use a separate TEST spreadsheet for development</strong></small>
                    </div>
                    
                    <button type="submit" class="setup-button">Save Development Config</button>
                    <button type="button" class="setup-button" onclick="testDevConnection()">Test Connection</button>
                </form>
            </div>
        </div>

        <!-- Production Environment -->
        <div class="env-card env-prod">
            <h3>üöÄ Production Environment</h3>
            <p><strong>Purpose:</strong> Live data, real volunteers, actual events</p>
            <p><strong>Data:</strong> Production data, real attendance records</p>
            
            <div id="prodStatus">
                <span class="status-indicator status-not-configured"></span>
                Not configured
            </div>

            <div class="credentials-form">
                <h4>Production Credentials</h4>
                <form id="prodCredentialsForm">
                    <div class="form-group">
                        <label for="prodApiKey">API Key:</label>
                        <input type="text" id="prodApiKey" name="apiKey" placeholder="AIza...">
                        <small>Same API key as development</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="prodClientId">OAuth Client ID:</label>
                        <input type="text" id="prodClientId" name="clientId" placeholder="123456789-...googleusercontent.com">
                        <small>Same client ID as development</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="prodSpreadsheetId">Production Spreadsheet ID:</label>
                        <input type="text" id="prodSpreadsheetId" name="spreadsheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
                        <small><strong>‚úÖ Use your MAIN production spreadsheet</strong></small>
                    </div>
                    
                    <button type="submit" class="setup-button">Save Production Config</button>
                    <button type="button" class="setup-button" onclick="testProdConnection()">Test Connection</button>
                </form>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="env-card">
            <h3>‚ö° Quick Actions</h3>
            <button class="setup-button" onclick="copyDevToProd()">Copy Dev Credentials to Prod</button>
            <button class="setup-button warning" onclick="clearAllCredentials()">Clear All Credentials</button>
            <button class="setup-button" onclick="exportConfiguration()">Export Configuration</button>
            <button class="setup-button" onclick="importConfiguration()">Import Configuration</button>
        </div>

        <!-- Setup Guide -->
        <div class="env-card">
            <h3>üìã Setup Guide</h3>
            <ol>
                <li><strong>Create Google Cloud Project:</strong> Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                <li><strong>Enable APIs:</strong> Enable Google Sheets API and Google Drive API</li>
                <li><strong>Create Credentials:</strong>
                    <ul>
                        <li>API Key (for Sheets API access)</li>
                        <li>OAuth 2.0 Client ID (for user authentication)</li>
                    </ul>
                </li>
                <li><strong>Create Spreadsheets:</strong>
                    <ul>
                        <li>Development: Create a test spreadsheet with sample data</li>
                        <li>Production: Create your main spreadsheet for real data</li>
                    </ul>
                </li>
                <li><strong>Configure Both Environments:</strong> Use the forms above to set up both dev and prod</li>
            </ol>
        </div>

        <!-- Action Log -->
        <div class="env-card">
            <h3>üìù Action Log</h3>
            <div id="actionLog" class="log"></div>
            <button class="setup-button" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <!-- Include necessary scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/google-sheets.js"></script>

    <script>
        let actionLog = document.getElementById('actionLog');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'success': '#28a745',
                'warning': '#ffc107', 
                'error': '#dc3545',
                'info': '#17a2b8'
            };
            const color = colors[type] || '#6c757d';
            actionLog.innerHTML += `<div style="color: ${color}; margin: 0.25rem 0;">[${timestamp}] ${message}</div>`;
            actionLog.scrollTop = actionLog.scrollHeight;
            console.log(message);
        }

        function updateEnvironmentDisplay() {
            const currentEnv = document.getElementById('currentEnvironment');
            const config = window.Config;
            
            currentEnv.innerHTML = `
                <div style="background: ${config.isDevelopment ? '#fff3cd' : '#d4edda'}; 
                           padding: 1rem; border-radius: 4px;">
                    <strong>Environment:</strong> ${config.environment.toUpperCase()}<br>
                    <strong>URL:</strong> ${window.location.href}<br>
                    <strong>Detection:</strong> ${config.isDevelopment ? 'Development' : 'Production'} mode<br>
                    <strong>Database:</strong> ${config.database.name}
                </div>
            `;
        }

        function updateStatus() {
            // Check development credentials
            const devCreds = localStorage.getItem('googleSheetsCredentials_development');
            const devStatusEl = document.getElementById('devStatus');
            
            if (devCreds) {
                const creds = JSON.parse(devCreds);
                devStatusEl.innerHTML = `
                    <span class="status-indicator status-configured"></span>
                    Configured (Spreadsheet: ${creds.spreadsheetId.substring(0, 20)}...)
                `;
                
                // Pre-fill form
                document.getElementById('devApiKey').value = creds.apiKey || '';
                document.getElementById('devClientId').value = creds.clientId || '';
                document.getElementById('devSpreadsheetId').value = creds.spreadsheetId || '';
            }

            // Check production credentials
            const prodCreds = localStorage.getItem('googleSheetsCredentials_production');
            const prodStatusEl = document.getElementById('prodStatus');
            
            if (prodCreds) {
                const creds = JSON.parse(prodCreds);
                prodStatusEl.innerHTML = `
                    <span class="status-indicator status-configured"></span>
                    Configured (Spreadsheet: ${creds.spreadsheetId.substring(0, 20)}...)
                `;
                
                // Pre-fill form
                document.getElementById('prodApiKey').value = creds.apiKey || '';
                document.getElementById('prodClientId').value = creds.clientId || '';
                document.getElementById('prodSpreadsheetId').value = creds.spreadsheetId || '';
            }
        }

        // Form handlers
        document.getElementById('devCredentialsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const credentials = {
                apiKey: formData.get('apiKey'),
                clientId: formData.get('clientId'),
                spreadsheetId: formData.get('spreadsheetId')
            };
            
            localStorage.setItem('googleSheetsCredentials_development', JSON.stringify(credentials));
            log('‚úÖ Development credentials saved', 'success');
            updateStatus();
        });

        document.getElementById('prodCredentialsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const credentials = {
                apiKey: formData.get('apiKey'),
                clientId: formData.get('clientId'),
                spreadsheetId: formData.get('spreadsheetId')
            };
            
            localStorage.setItem('googleSheetsCredentials_production', JSON.stringify(credentials));
            log('‚úÖ Production credentials saved', 'success');
            updateStatus();
        });

        async function testDevConnection() {
            log('üß™ Testing development connection...');
            // Implementation would test the connection
            log('‚ö†Ô∏è Connection testing not implemented yet', 'warning');
        }

        async function testProdConnection() {
            log('üöÄ Testing production connection...');
            // Implementation would test the connection
            log('‚ö†Ô∏è Connection testing not implemented yet', 'warning');
        }

        function copyDevToProd() {
            const devCreds = localStorage.getItem('googleSheetsCredentials_development');
            if (!devCreds) {
                log('‚ùå No development credentials to copy', 'error');
                return;
            }

            const creds = JSON.parse(devCreds);
            
            // Copy API key and client ID, but ask for different spreadsheet ID
            document.getElementById('prodApiKey').value = creds.apiKey || '';
            document.getElementById('prodClientId').value = creds.clientId || '';
            
            log('‚úÖ Copied API credentials from dev to prod (spreadsheet ID not copied)', 'success');
            log('‚ö†Ô∏è Please enter a different spreadsheet ID for production', 'warning');
        }

        function clearAllCredentials() {
            if (confirm('Are you sure you want to clear ALL credentials? This cannot be undone.')) {
                localStorage.removeItem('googleSheetsCredentials_development');
                localStorage.removeItem('googleSheetsCredentials_production');
                localStorage.removeItem('googleSheetsCredentials'); // Legacy
                localStorage.removeItem('googleSheetsToken');
                
                // Clear forms
                document.getElementById('devCredentialsForm').reset();
                document.getElementById('prodCredentialsForm').reset();
                
                log('üßπ All credentials cleared', 'success');
                updateStatus();
            }
        }

        function exportConfiguration() {
            const config = {
                development: localStorage.getItem('googleSheetsCredentials_development'),
                production: localStorage.getItem('googleSheetsCredentials_production')
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'google-sheets-config.json';
            a.click();
            URL.revokeObjectURL(url);
            
            log('üì§ Configuration exported', 'success');
        }

        function importConfiguration() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const config = JSON.parse(e.target.result);
                            
                            if (config.development) {
                                localStorage.setItem('googleSheetsCredentials_development', config.development);
                            }
                            if (config.production) {
                                localStorage.setItem('googleSheetsCredentials_production', config.production);
                            }
                            
                            log('üì• Configuration imported successfully', 'success');
                            updateStatus();
                        } catch (error) {
                            log('‚ùå Failed to import configuration: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearLog() {
            actionLog.innerHTML = '';
            log('üìù Log cleared');
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            log('üìä Google Sheets Environment Setup loaded');
            updateEnvironmentDisplay();
            updateStatus();
        });
    </script>
</body>
</html>