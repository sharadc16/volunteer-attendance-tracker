<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Add Event Click Issue</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button { margin: 10px; padding: 10px 20px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Add Event Click Issue</h1>
    
    <div id="results"></div>
    
    <button onclick="runFullDiagnostic()">üöÄ Run Full Diagnostic</button>
    <button onclick="testDirectCall()">üìû Test Direct Function Call</button>
    <button onclick="testModalSystem()">ü™ü Test Modal System</button>
    <button onclick="checkConsoleErrors()">‚ö†Ô∏è Check Console Errors</button>
    <button onclick="simulateClick()">üñ±Ô∏è Simulate Button Click</button>
    
    <script>
        let errorLog = [];
        
        // Capture console errors
        const originalError = console.error;
        console.error = function(...args) {
            errorLog.push({
                timestamp: new Date().toISOString(),
                message: args.join(' '),
                stack: new Error().stack
            });
            originalError.apply(console, args);
        };
        
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function getApp() {
            return window.opener?.app || parent.app || window.app;
        }
        
        function runFullDiagnostic() {
            addResult('üöÄ Starting full diagnostic...', 'info');
            
            // Test 1: Check app object
            const app = getApp();
            if (app) {
                addResult('‚úÖ App object found', 'success');
                addResult(`App initialized: ${app.isInitialized}`, 'info');
                addResult(`Current view: ${app.currentView}`, 'info');
            } else {
                addResult('‚ùå App object NOT found', 'error');
                return;
            }
            
            // Test 2: Check if we're on events view
            if (app.currentView !== 'events') {
                addResult('‚ö†Ô∏è Not on events view, switching...', 'warning');
                app.switchView('events');
                setTimeout(() => continueAfterViewSwitch(app), 500);
            } else {
                continueAfterViewSwitch(app);
            }
        }
        
        function continueAfterViewSwitch(app) {
            // Test 3: Check button existence and properties
            const addEventBtn = document.getElementById('addEventBtn');
            if (addEventBtn) {
                addResult('‚úÖ Add Event button found', 'success');
                addResult(`Button visible: ${addEventBtn.offsetWidth > 0 && addEventBtn.offsetHeight > 0}`, 'info');
                addResult(`Button disabled: ${addEventBtn.disabled}`, 'info');
                addResult(`Button onclick: ${addEventBtn.onclick}`, 'info');
                
                // Check computed styles
                const styles = window.getComputedStyle(addEventBtn);
                addResult(`Button display: ${styles.display}`, 'info');
                addResult(`Button visibility: ${styles.visibility}`, 'info');
                addResult(`Button pointer-events: ${styles.pointerEvents}`, 'info');
                
            } else {
                addResult('‚ùå Add Event button NOT found', 'error');
                return;
            }
            
            // Test 4: Check showAddEventModal function
            if (typeof app.showAddEventModal === 'function') {
                addResult('‚úÖ showAddEventModal function exists', 'success');
            } else {
                addResult('‚ùå showAddEventModal function NOT found', 'error');
                return;
            }
            
            // Test 5: Check modal elements
            const modalElements = ['modalOverlay', 'modalTitle', 'modalBody', 'modalConfirm', 'modalCancel'];
            let modalElementsOk = true;
            modalElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    addResult(`‚úÖ ${id} found`, 'success');
                } else {
                    addResult(`‚ùå ${id} NOT found`, 'error');
                    modalElementsOk = false;
                }
            });
            
            if (!modalElementsOk) {
                addResult('‚ùå Modal system incomplete - this is likely the issue!', 'error');
            }
            
            // Test 6: Check for JavaScript errors
            if (errorLog.length > 0) {
                addResult(`‚ö†Ô∏è Found ${errorLog.length} console errors:`, 'warning');
                errorLog.forEach((error, index) => {
                    addResult(`Error ${index + 1}: ${error.message}`, 'error');
                });
            } else {
                addResult('‚úÖ No console errors detected', 'success');
            }
        }
        
        function testDirectCall() {
            addResult('üìû Testing direct function call...', 'info');
            const app = getApp();
            
            if (app && typeof app.showAddEventModal === 'function') {
                try {
                    addResult('Calling app.showAddEventModal()...', 'info');
                    app.showAddEventModal();
                    
                    // Check if modal appeared
                    setTimeout(() => {
                        const modalOverlay = document.getElementById('modalOverlay');
                        if (modalOverlay && modalOverlay.classList.contains('active')) {
                            addResult('‚úÖ Modal appeared - function works!', 'success');
                        } else {
                            addResult('‚ùå Modal did NOT appear - function failed silently', 'error');
                        }
                    }, 200);
                    
                } catch (error) {
                    addResult(`‚ùå Direct call failed: ${error.message}`, 'error');
                    addResult(`Error stack: ${error.stack}`, 'error');
                }
            } else {
                addResult('‚ùå Cannot test - app or function not available', 'error');
            }
        }
        
        function testModalSystem() {
            addResult('ü™ü Testing modal system...', 'info');
            const app = getApp();
            
            if (app && typeof app.showModal === 'function') {
                try {
                    addResult('Testing basic modal...', 'info');
                    app.showModal('Test Modal', '<p>This is a test modal</p>', 'OK', 'Cancel');
                    
                    setTimeout(() => {
                        const modalOverlay = document.getElementById('modalOverlay');
                        if (modalOverlay && modalOverlay.classList.contains('active')) {
                            addResult('‚úÖ Basic modal works!', 'success');
                            // Close the test modal
                            app.hideModal();
                        } else {
                            addResult('‚ùå Basic modal failed', 'error');
                        }
                    }, 200);
                    
                } catch (error) {
                    addResult(`‚ùå Modal system error: ${error.message}`, 'error');
                }
            } else {
                addResult('‚ùå showModal function not available', 'error');
            }
        }
        
        function checkConsoleErrors() {
            addResult('‚ö†Ô∏è Checking console errors...', 'info');
            
            if (errorLog.length === 0) {
                addResult('‚úÖ No errors in error log', 'success');
            } else {
                addResult(`Found ${errorLog.length} errors:`, 'warning');
                errorLog.forEach((error, index) => {
                    addResult(`${index + 1}. ${error.message}`, 'error');
                });
            }
            
            // Also check for any unhandled promise rejections
            window.addEventListener('unhandledrejection', (event) => {
                addResult(`Unhandled promise rejection: ${event.reason}`, 'error');
            });
        }
        
        function simulateClick() {
            addResult('üñ±Ô∏è Simulating button click...', 'info');
            
            const app = getApp();
            if (app && app.currentView !== 'events') {
                addResult('Switching to events view first...', 'info');
                app.switchView('events');
                setTimeout(doSimulateClick, 500);
            } else {
                doSimulateClick();
            }
        }
        
        function doSimulateClick() {
            const addEventBtn = document.getElementById('addEventBtn');
            if (addEventBtn) {
                addResult('Button found, simulating click...', 'info');
                
                // Try multiple click methods
                try {
                    // Method 1: Direct click
                    addEventBtn.click();
                    addResult('‚úÖ Direct click() called', 'success');
                } catch (e) {
                    addResult(`‚ùå Direct click failed: ${e.message}`, 'error');
                }
                
                try {
                    // Method 2: Dispatch click event
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    addEventBtn.dispatchEvent(clickEvent);
                    addResult('‚úÖ Click event dispatched', 'success');
                } catch (e) {
                    addResult(`‚ùå Event dispatch failed: ${e.message}`, 'error');
                }
                
                // Check result
                setTimeout(() => {
                    const modalOverlay = document.getElementById('modalOverlay');
                    if (modalOverlay && modalOverlay.classList.contains('active')) {
                        addResult('‚úÖ Modal appeared after click simulation!', 'success');
                    } else {
                        addResult('‚ùå No modal appeared after click simulation', 'error');
                    }
                }, 300);
                
            } else {
                addResult('‚ùå Button not found for simulation', 'error');
            }
        }
        
        // Auto-run basic checks
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('üîç Auto-running basic checks...', 'info');
                checkConsoleErrors();
            }, 1000);
        });
    </script>
</body>
</html>