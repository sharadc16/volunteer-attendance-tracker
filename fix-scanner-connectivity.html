<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Scanner Connectivity Issue</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîß Fix Scanner Connectivity Issue</h1>
    
    <div class="test-container">
        <h2>Issue Description</h2>
        <div class="status error">
            <strong>Problem:</strong> Scanner shows "System not ready - check connectivity" and "Cloud sync unavailable" even though Google Sheets sync is working successfully.
            <br><br>
            <strong>Root Cause:</strong> Connectivity validator is too strict and fails validation even when sync is actually working.
        </div>
    </div>

    <div class="test-container">
        <h2>Diagnostic Actions</h2>
        <button onclick="checkConnectivityStatus()">üîç Check Connectivity Status</button>
        <button onclick="testActualSync()">üìä Test Actual Sync</button>
        <button onclick="fixConnectivityValidation()">üîß Fix Connectivity Validation</button>
        <button onclick="enableScanner()">‚úÖ Force Enable Scanner</button>
        <button onclick="clearLog()">üßπ Clear Log</button>
    </div>

    <div class="test-container">
        <h2>Scanner Status</h2>
        <div id="scannerStatus">Checking...</div>
    </div>

    <div class="test-container">
        <h2>Fix Log</h2>
        <div id="log"></div>
    </div>

    <!-- Load dependencies -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/environment-manager.js"></script>
    <script src="js/google-sheets.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/connectivity-validator.js"></script>
    <script src="js/scanner.js"></script>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            document.getElementById('log').textContent += logEntry + '\n';
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
        }
        
        function updateScannerStatus(status, type = 'info') {
            const statusDiv = document.getElementById('scannerStatus');
            statusDiv.innerHTML = `<div class="status ${type}">${status}</div>`;
        }
        
        async function checkConnectivityStatus() {
            log('üîç Checking connectivity status...');
            
            try {
                if (!window.connectivityValidator) {
                    log('‚ùå Connectivity validator not available');
                    return;
                }
                
                const validator = window.connectivityValidator;
                
                // Check overall status
                const isReady = validator.isReadyToScan();
                log(`üìä System ready to scan: ${isReady}`);
                
                // Check validation results
                const results = validator.validationResults;
                log('üìä Validation results:');
                log(`  - Local Storage: ${results.localStorage.status}`);
                log(`  - Google Sheets: ${results.googleSheets.status}`);
                log(`  - Overall: ${results.overall.status} (Ready: ${results.overall.readyToScan})`);
                
                if (results.googleSheets.details) {
                    log('üìä Google Sheets details:');
                    log(`  - Connected: ${results.googleSheets.details.connected}`);
                    log(`  - Authenticated: ${results.googleSheets.details.authenticated}`);
                    log(`  - Error: ${results.googleSheets.details.error || 'None'}`);
                }
                
                updateScannerStatus(
                    `Ready to scan: ${isReady ? 'Yes' : 'No'}<br>Overall status: ${results.overall.status}`,
                    isReady ? 'success' : 'error'
                );
                
            } catch (error) {
                log(`‚ùå Error checking connectivity status: ${error.message}`);
            }
        }
        
        async function testActualSync() {
            log('üìä Testing actual Google Sheets sync...');
            
            try {
                if (!window.googleSheetsService) {
                    window.googleSheetsService = new GoogleSheetsService();
                }
                
                const service = window.googleSheetsService;
                
                // Test authentication
                await service.ensureAuthenticated();
                log('‚úÖ Authentication successful');
                
                // Test reading data
                const data = await service.readSheet('Events');
                log(`‚úÖ Successfully read ${data.length} rows from Google Sheets`);
                
                // Test sync manager
                if (window.StorageManager && window.StorageManager.syncEventsFromGoogleSheets) {
                    await window.StorageManager.syncEventsFromGoogleSheets();
                    log('‚úÖ Sync manager working successfully');
                } else {
                    log('‚ö†Ô∏è Sync manager not available');
                }
                
                log('üéâ Actual sync is working perfectly!');
                
            } catch (error) {
                log(`‚ùå Actual sync test failed: ${error.message}`);
            }
        }
        
        async function fixConnectivityValidation() {
            log('üîß Fixing connectivity validation logic...');
            
            try {
                if (!window.connectivityValidator) {
                    log('‚ùå Connectivity validator not available');
                    return;
                }
                
                const validator = window.connectivityValidator;
                
                // Override the Google Sheets validation to be more lenient
                const originalValidateGoogleSheets = validator.validateGoogleSheetsConnectivity;
                
                validator.validateGoogleSheetsConnectivity = async function() {
                    log('üîß Using improved Google Sheets validation...');
                    
                    try {
                        // First try the original validation
                        const result = await originalValidateGoogleSheets.call(this);
                        
                        // If it failed, but we can actually sync, override the result
                        if (result.status === 'error') {
                            log('‚ö†Ô∏è Original validation failed, testing actual sync...');
                            
                            try {
                                // Test if sync actually works
                                if (window.googleSheetsService) {
                                    await window.googleSheetsService.ensureAuthenticated();
                                    const testData = await window.googleSheetsService.readSheet('Events');
                                    
                                    if (testData && testData.length > 0) {
                                        log('‚úÖ Actual sync works, overriding validation result');
                                        result.status = 'success';
                                        result.details.connected = true;
                                        result.details.authenticated = true;
                                        result.details.spreadsheetAccessible = true;
                                        result.details.error = null;
                                    }
                                }
                            } catch (syncError) {
                                log(`‚ùå Sync test also failed: ${syncError.message}`);
                            }
                        }
                        
                        return result;
                        
                    } catch (error) {
                        log(`‚ùå Validation fix failed: ${error.message}`);
                        return {
                            status: 'error',
                            details: { error: error.message }
                        };
                    }
                };
                
                // Force a re-validation
                await validator.performFullValidation();
                log('‚úÖ Connectivity validation fixed and re-run');
                
                // Check the new status
                await checkConnectivityStatus();
                
            } catch (error) {
                log(`‚ùå Error fixing connectivity validation: ${error.message}`);
            }
        }
        
        async function enableScanner() {
            log('‚úÖ Force enabling scanner...');
            
            try {
                // Find the scanner input
                const scannerInput = document.getElementById('volunteerId');
                if (scannerInput) {
                    scannerInput.disabled = false;
                    scannerInput.placeholder = 'Scan badge or enter volunteer ID...';
                    log('‚úÖ Scanner input enabled');
                } else {
                    log('‚ùå Scanner input not found');
                }
                
                // Try to enable via scanner service
                if (window.scanner && window.scanner.enableScanner) {
                    window.scanner.enableScanner();
                    log('‚úÖ Scanner service enabled');
                }
                
                // Override connectivity validator to always return ready
                if (window.connectivityValidator) {
                    const originalIsReady = window.connectivityValidator.isReadyToScan;
                    window.connectivityValidator.isReadyToScan = function() {
                        log('üîß Overriding readiness check to return true');
                        return true;
                    };
                    log('‚úÖ Readiness check overridden');
                }
                
                updateScannerStatus('‚úÖ Scanner force-enabled', 'success');
                
            } catch (error) {
                log(`‚ùå Error enabling scanner: ${error.message}`);
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', async () => {
            log('üöÄ Scanner connectivity fix tool loaded');
            
            // Auto-check status
            setTimeout(checkConnectivityStatus, 1000);
        });
    </script>
</body>
</html>