<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Manual Scanner Fix</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 1.5rem 0;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .output {
            background: #212529;
            color: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .nav-link {
            display: inline-block;
            background: #6c757d;
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 0.25rem;
        }
        .nav-link:hover {
            background: #5a6268;
            text-decoration: none;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Manual Scanner Fix</h1>
        <p>Step-by-step manual fix for scanner issues. Each step can be run independently.</p>

        <div style="text-align: center; margin: 1rem 0;">
            <a href="index.html" class="nav-link">üè† Main App</a>
            <a href="force-enable-scanner.html" class="nav-link">‚ö° Force Enable</a>
            <a href="debug-scanner-console.js" class="nav-link">üîç Debug Console</a>
        </div>

        <div class="step">
            <h3>Step 1: Initialize Storage</h3>
            <p>Make sure storage system is ready</p>
            <button class="btn" onclick="initStorage()">Initialize Storage</button>
            <div id="storageOutput" class="output" style="display: none;"></div>
        </div>

        <div class="step">
            <h3>Step 2: Analyze Events</h3>
            <p>Check for event date mismatches</p>
            <button class="btn btn-warning" onclick="analyzeEvents()">Analyze Events</button>
            <div id="analyzeOutput" class="output" style="display: none;"></div>
        </div>

        <div class="step">
            <h3>Step 3: Create Today's Event</h3>
            <p>Create an event for today if missing</p>
            <button class="btn" onclick="createToday()">Create Today's Event</button>
            <div id="todayOutput" class="output" style="display: none;"></div>
        </div>

        <div class="step">
            <h3>Step 4: Fix Sep 8/9 Mismatch</h3>
            <p>Fix the specific September 8/9 date issue</p>
            <button class="btn" onclick="fixSep8()">Fix Sep 8/9</button>
            <div id="sep8Output" class="output" style="display: none;"></div>
        </div>

        <div class="step">
            <h3>Step 5: Test Scanner</h3>
            <p>Check if scanner is working after fixes</p>
            <button class="btn btn-success" onclick="testScanner()">Test Scanner</button>
            <div id="scannerOutput" class="output" style="display: none;"></div>
        </div>

        <div class="step">
            <h3>Step 6: Fix "Loading..." Event</h3>
            <p>Fix current event showing "Loading..." instead of event name</p>
            <button class="btn" onclick="fixLoadingEvent()">Fix Loading Event</button>
            <div id="loadingOutput" class="output" style="display: none;"></div>
        </div>

        <div class="step">
            <h3>Step 7: Full Diagnosis</h3>
            <p>Complete analysis of all scanner and event issues</p>
            <button class="btn btn-warning" onclick="fullDiagnosis()">Full Diagnosis</button>
            <div id="diagnosisOutput" class="output" style="display: none;"></div>
        </div>

        <div class="step">
            <h3>Step 8: Force Enable (Emergency)</h3>
            <p>Force enable scanner for immediate testing</p>
            <button class="btn btn-warning" onclick="forceEnable()">Force Enable Scanner</button>
            <div id="forceOutput" class="output" style="display: none;"></div>
        </div>
    </div>

    <!-- Include app scripts -->
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/google-sheets.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/scanner.js"></script>
    <script src="js/app.js"></script>

    <script>
        function log(outputId, message, type = 'info') {
            const output = document.getElementById(outputId);
            output.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : 
                         type === 'warning' ? '#ffc107' : 
                         type === 'success' ? '#28a745' : '#f8f9fa';
            
            output.innerHTML += `<span style="color: #6c757d">[${timestamp}]</span> <span style="color: ${color}">${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        async function initStorage() {
            log('storageOutput', 'üîÑ Initializing storage...', 'info');
            
            try {
                if (window.StorageManager) {
                    await window.StorageManager.init();
                    log('storageOutput', '‚úÖ Storage initialized successfully', 'success');
                } else if (window.storage) {
                    await window.storage.init();
                    log('storageOutput', '‚úÖ Storage initialized successfully', 'success');
                } else {
                    log('storageOutput', '‚ùå Storage system not found', 'error');
                }
            } catch (error) {
                log('storageOutput', `‚ùå Storage init failed: ${error.message}`, 'error');
            }
        }

        async function analyzeEvents() {
            log('analyzeOutput', 'üîç Analyzing events...', 'info');
            
            try {
                const storage = window.StorageManager || window.storage;
                if (!storage) {
                    log('analyzeOutput', '‚ùå Storage not available', 'error');
                    return;
                }

                const allEvents = await storage.getAllEvents();
                log('analyzeOutput', `üìÖ Found ${allEvents.length} events`, 'info');
                
                const mismatches = [];
                
                allEvents.forEach(event => {
                    const idMatch = event.eventId.match(/^E(\d{4})(\d{2})(\d{2})$/);
                    if (idMatch) {
                        const [, year, month, day] = idMatch;
                        const expectedDate = `${year}-${month}-${day}`;
                        
                        if (event.date !== expectedDate) {
                            mismatches.push({
                                eventId: event.eventId,
                                storedDate: event.date,
                                expectedDate: expectedDate
                            });
                        }
                    }
                });
                
                log('analyzeOutput', `üìä Found ${mismatches.length} mismatches`, mismatches.length > 0 ? 'warning' : 'success');
                
                mismatches.forEach(mismatch => {
                    log('analyzeOutput', `  ${mismatch.eventId}: ${mismatch.storedDate} ‚Üí ${mismatch.expectedDate}`, 'warning');
                });
                
            } catch (error) {
                log('analyzeOutput', `‚ùå Analysis failed: ${error.message}`, 'error');
            }
        }

        async function createToday() {
            log('todayOutput', 'üìÖ Creating today\'s event...', 'info');
            
            try {
                const storage = window.StorageManager || window.storage;
                if (!storage) {
                    log('todayOutput', '‚ùå Storage not available', 'error');
                    return;
                }

                const today = new Date();
                const todayStr = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
                
                const todayEventId = `E${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                
                log('todayOutput', `üìÖ Today: ${todayStr}, ID: ${todayEventId}`, 'info');
                
                // Check if exists
                try {
                    const existing = await storage.getEvent(todayEventId);
                    if (existing) {
                        log('todayOutput', '‚úÖ Event already exists: ' + existing.eventName, 'success');
                        return;
                    }
                } catch (e) {
                    // Doesn't exist, continue
                }
                
                // Create new event
                const newEvent = {
                    eventId: todayEventId,
                    eventName: `Event for ${today.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        month: 'short', 
                        day: 'numeric' 
                    })}`,
                    date: todayStr,
                    type: 'Regular',
                    status: 'Active',
                    description: 'Auto-created event for today'
                };
                
                await storage.addEvent(newEvent);
                log('todayOutput', '‚úÖ Created: ' + newEvent.eventName, 'success');
                
            } catch (error) {
                log('todayOutput', `‚ùå Failed: ${error.message}`, 'error');
            }
        }

        async function fixSep8() {
            log('sep8Output', 'üîß Fixing Sep 8/9 mismatch...', 'info');
            
            try {
                const storage = window.StorageManager || window.storage;
                if (!storage) {
                    log('sep8Output', '‚ùå Storage not available', 'error');
                    return;
                }

                // Get E20250908 event
                const event = await storage.getEvent('E20250908');
                if (!event) {
                    log('sep8Output', '‚ùå Event E20250908 not found', 'error');
                    return;
                }
                
                log('sep8Output', `üìÖ Found: ${event.eventName} (${event.date})`, 'info');
                
                // Fix date to match ID
                const updatedEvent = { ...event, date: '2025-09-08' };
                await storage.updateEvent(updatedEvent);
                
                log('sep8Output', '‚úÖ Fixed date to 2025-09-08', 'success');
                
                // Also create E20250909 if needed
                try {
                    const sep9Event = await storage.getEvent('E20250909');
                    if (!sep9Event) {
                        const newSep9 = {
                            eventId: 'E20250909',
                            eventName: event.eventName.replace('Sep 8', 'Sep 9').replace('Monday', 'Tuesday'),
                            date: '2025-09-09',
                            type: event.type,
                            status: event.status,
                            description: 'Corrected event for September 9'
                        };
                        
                        await storage.addEvent(newSep9);
                        log('sep8Output', '‚úÖ Created E20250909 event', 'success');
                    }
                } catch (e) {
                    log('sep8Output', '‚ö†Ô∏è Could not create Sep 9 event', 'warning');
                }
                
            } catch (error) {
                log('sep8Output', `‚ùå Failed: ${error.message}`, 'error');
            }
        }

        async function testScanner() {
            log('scannerOutput', 'üîÑ Testing scanner...', 'info');
            
            try {
                // Check if scanner exists
                if (window.scanner) {
                    log('scannerOutput', '‚úÖ Scanner object found', 'success');
                    
                    // Update scanner status
                    if (typeof window.scanner.updateScannerStatus === 'function') {
                        await window.scanner.updateScannerStatus();
                        log('scannerOutput', '‚úÖ Scanner status updated', 'success');
                    }
                } else {
                    log('scannerOutput', '‚ö†Ô∏è Scanner object not found', 'warning');
                }
                
                // Check scanner input element
                const scannerInput = document.getElementById('scannerInput');
                if (scannerInput) {
                    log('scannerOutput', `üì± Scanner input: ${scannerInput.disabled ? 'DISABLED' : 'ENABLED'}`, 
                        scannerInput.disabled ? 'warning' : 'success');
                    log('scannerOutput', `üì± Placeholder: "${scannerInput.placeholder}"`, 'info');
                } else {
                    log('scannerOutput', '‚ùå Scanner input element not found', 'error');
                }
                
                // Check current event
                if (window.app && typeof window.app.getCurrentEvent === 'function') {
                    const currentEvent = await window.app.getCurrentEvent();
                    if (currentEvent) {
                        log('scannerOutput', `üìÖ Current event: ${currentEvent.eventName}`, 'success');
                    } else {
                        log('scannerOutput', '‚ö†Ô∏è No current event found', 'warning');
                    }
                }
                
            } catch (error) {
                log('scannerOutput', `‚ùå Test failed: ${error.message}`, 'error');
            }
        }

        async function forceEnable() {
            log('forceOutput', '‚ö° Force enabling scanner...', 'info');
            
            try {
                const scannerInput = document.getElementById('scannerInput');
                if (scannerInput) {
                    scannerInput.disabled = false;
                    scannerInput.placeholder = 'Scan volunteer ID (Force Enabled)';
                    log('forceOutput', '‚úÖ Scanner force enabled', 'success');
                } else {
                    log('forceOutput', '‚ùå Scanner input not found', 'error');
                }
                
                // Also try global force enable function
                if (window.forceEnableScanner) {
                    window.forceEnableScanner();
                    log('forceOutput', '‚úÖ Global force enable called', 'success');
                }
                
            } catch (error) {
                log('forceOutput', `‚ùå Force enable failed: ${error.message}`, 'error');
            }
        }

        async function fixLoadingEvent() {
            log('loadingOutput', 'üîß Fixing "Loading..." event display...', 'info');
            
            try {
                const today = new Date();
                const todayEventName = `Event for ${today.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'short', 
                    day: 'numeric' 
                })}`;
                
                // Update current event display
                const currentEventElement = document.getElementById('currentEvent');
                if (currentEventElement) {
                    currentEventElement.textContent = todayEventName;
                    log('loadingOutput', '‚úÖ Updated current event display', 'success');
                } else {
                    log('loadingOutput', '‚ùå Current event element not found', 'error');
                }
                
                // Also update scanner if available
                if (window.scanner && typeof window.scanner.updateScannerStatus === 'function') {
                    await window.scanner.updateScannerStatus();
                    log('loadingOutput', '‚úÖ Scanner status updated', 'success');
                }
                
            } catch (error) {
                log('loadingOutput', `‚ùå Fix loading event failed: ${error.message}`, 'error');
            }
        }

        async function fullDiagnosis() {
            log('diagnosisOutput', 'üîç Running full system diagnosis...', 'info');
            
            try {
                // Check storage
                const storage = window.StorageManager || window.storage;
                if (storage) {
                    const allEvents = await storage.getAllEvents();
                    log('diagnosisOutput', `üìÖ Total events: ${allEvents.length}`, 'info');
                    
                    // Check for today's event
                    const today = new Date();
                    const todayEventId = `E${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                    
                    const todayEvent = allEvents.find(e => e.eventId === todayEventId);
                    if (todayEvent) {
                        log('diagnosisOutput', `‚úÖ Today's event found: ${todayEvent.eventName}`, 'success');
                    } else {
                        log('diagnosisOutput', `‚ùå Today's event missing: ${todayEventId}`, 'error');
                    }
                    
                    // Check for date mismatches
                    const mismatches = allEvents.filter(event => {
                        const idMatch = event.eventId.match(/^E(\d{4})(\d{2})(\d{2})$/);
                        if (idMatch) {
                            const [, year, month, day] = idMatch;
                            const expectedDate = `${year}-${month}-${day}`;
                            return event.date !== expectedDate;
                        }
                        return false;
                    });
                    
                    log('diagnosisOutput', `üìä Date mismatches: ${mismatches.length}`, mismatches.length > 0 ? 'warning' : 'success');
                }
                
                // Check scanner
                const scannerInput = document.getElementById('scannerInput');
                if (scannerInput) {
                    log('diagnosisOutput', `üì± Scanner: ${scannerInput.disabled ? 'DISABLED' : 'ENABLED'}`, scannerInput.disabled ? 'warning' : 'success');
                } else {
                    log('diagnosisOutput', '‚ùå Scanner input not found', 'error');
                }
                
                // Check current event display
                const currentEventElement = document.getElementById('currentEvent');
                if (currentEventElement) {
                    const text = currentEventElement.textContent;
                    log('diagnosisOutput', `üìã Current event display: "${text}"`, text.includes('Loading') ? 'warning' : 'success');
                } else {
                    log('diagnosisOutput', '‚ùå Current event element not found', 'error');
                }
                
                log('diagnosisOutput', '‚úÖ Full diagnosis completed', 'success');
                
            } catch (error) {
                log('diagnosisOutput', `‚ùå Diagnosis failed: ${error.message}`, 'error');
            }
        }

        // Auto-initialize on load
        window.addEventListener('load', async () => {
            console.log('üîß Manual scanner fix tool loaded');
            
            // Auto-initialize storage
            setTimeout(() => {
                initStorage();
            }, 1000);
        });
    </script>
</body>
</html>