<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Events Loading Issue</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .fix-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .btn {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.9; }
        .step {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .step h3 {
            margin-top: 0;
            color: #007bff;
        }
        .progress {
            background: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin: 10px 0;
        }
        .progress-bar {
            background: #007bff;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <h1>üîß Fix Events Loading Issue</h1>
        <p>This tool will help fix the events not loading issue by creating sample events and ensuring the sync system works properly.</p>

        <div id="currentStatus" class="status info">
            <strong>Status:</strong> Checking system...
        </div>

        <div class="progress">
            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
        </div>

        <div class="step">
            <h3>Step 1: Create Sample Events</h3>
            <p>Create some sample events to test the system:</p>
            <button class="btn btn-success" onclick="createSampleEvents()">üìÖ Create Sample Events</button>
            <button class="btn btn-primary" onclick="createTodayEvent()">üéØ Create Today's Event</button>
        </div>

        <div class="step">
            <h3>Step 2: Fix Sync System</h3>
            <p>Ensure the sync system is working properly:</p>
            <button class="btn btn-warning" onclick="disableGoogleSync()">‚è∏Ô∏è Disable Google Sync</button>
            <button class="btn btn-primary" onclick="enableLocalMode()">üíæ Enable Local Mode</button>
            <button class="btn btn-success" onclick="testSyncSystem()">üîÑ Test Sync System</button>
        </div>

        <div class="step">
            <h3>Step 3: Verify Fix</h3>
            <p>Test that events are now loading properly:</p>
            <button class="btn btn-primary" onclick="testEventsLoading()">üß™ Test Events Loading</button>
            <button class="btn btn-success" onclick="openMainApp()">üöÄ Open Main App</button>
        </div>

        <div id="logOutput" style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 14px; max-height: 300px; overflow-y: auto; margin-top: 20px;">
            Initializing fix tool...
        </div>
    </div>

    <!-- Load essential scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>

    <script>
        let logMessages = [];
        let currentStep = 0;
        const totalSteps = 6;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logMessages.push(`[${timestamp}] ${message}`);
            document.getElementById('logOutput').textContent = logMessages.slice(-20).join('\n');
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('currentStatus');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = `<strong>Status:</strong> ${message}`;
        }
        
        function updateProgress(step) {
            currentStep = step;
            const percentage = (step / totalSteps) * 100;
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }
        
        async function waitForStorage() {
            log('Waiting for storage manager...');
            let attempts = 0;
            while (!window.StorageManager || !window.StorageManager.db) {
                if (attempts > 100) {
                    throw new Error('Storage initialization timeout');
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            log('‚úÖ Storage manager ready');
        }
        
        async function createSampleEvents() {
            try {
                updateStatus('Creating sample events...', 'info');
                await waitForStorage();
                
                const today = new Date();
                const events = [
                    {
                        eventId: `TODAY_${Date.now()}`,
                        eventName: 'Sunday Service',
                        date: today.toISOString().split('T')[0],
                        type: 'Recurring',
                        status: 'Active'
                    },
                    {
                        eventId: `YESTERDAY_${Date.now()}`,
                        eventName: 'Saturday Evening Service',
                        date: new Date(today.getTime() - 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        type: 'Recurring',
                        status: 'Active'
                    },
                    {
                        eventId: `NEXT_WEEK_${Date.now()}`,
                        eventName: 'Next Sunday Service',
                        date: new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        type: 'Recurring',
                        status: 'Active'
                    },
                    {
                        eventId: `SPECIAL_${Date.now()}`,
                        eventName: 'Special Prayer Meeting',
                        date: new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        type: 'Special',
                        status: 'Active'
                    }
                ];
                
                for (const event of events) {
                    await window.StorageManager.addEvent(event);
                    log(`‚úÖ Created event: ${event.eventName} (${event.date})`);
                }
                
                updateStatus(`Successfully created ${events.length} sample events`, 'success');
                updateProgress(1);
                
            } catch (error) {
                log(`‚ùå Failed to create sample events: ${error.message}`);
                updateStatus(`Error creating events: ${error.message}`, 'error');
            }
        }
        
        async function createTodayEvent() {
            try {
                updateStatus('Creating today\'s event...', 'info');
                await waitForStorage();
                
                const today = new Date();
                const todayEvent = {
                    eventId: `TODAY_MAIN_${Date.now()}`,
                    eventName: 'Today\'s Main Service',
                    date: today.toISOString().split('T')[0],
                    type: 'Recurring',
                    status: 'Active'
                };
                
                await window.StorageManager.addEvent(todayEvent);
                log(`‚úÖ Created today's event: ${todayEvent.eventName}`);
                
                updateStatus('Successfully created today\'s event', 'success');
                updateProgress(2);
                
            } catch (error) {
                log(`‚ùå Failed to create today's event: ${error.message}`);
                updateStatus(`Error creating today's event: ${error.message}`, 'error');
            }
        }
        
        async function disableGoogleSync() {
            try {
                updateStatus('Disabling Google Sheets sync...', 'info');
                
                // Disable sync in config
                if (window.Config && window.Config.features) {
                    window.Config.features.googleSheetsSync = false;
                    log('‚úÖ Disabled Google Sheets sync in config');
                }
                
                // Stop sync manager
                if (window.SyncManager) {
                    window.SyncManager.stopSync();
                    log('‚úÖ Stopped sync manager');
                }
                
                // Clear sync queue
                if (window.SyncManager && typeof window.SyncManager.clearSyncQueue === 'function') {
                    await window.SyncManager.clearSyncQueue();
                    log('‚úÖ Cleared sync queue');
                }
                
                updateStatus('Google Sheets sync disabled', 'success');
                updateProgress(3);
                
            } catch (error) {
                log(`‚ùå Failed to disable Google sync: ${error.message}`);
                updateStatus(`Error disabling sync: ${error.message}`, 'error');
            }
        }
        
        async function enableLocalMode() {
            try {
                updateStatus('Enabling local-only mode...', 'info');
                
                // Set local mode in localStorage
                localStorage.setItem('forceLocalMode', 'true');
                localStorage.setItem('disableGoogleSync', 'true');
                
                log('‚úÖ Enabled local-only mode');
                log('‚úÖ Google Sheets sync will be disabled on next load');
                
                updateStatus('Local-only mode enabled', 'success');
                updateProgress(4);
                
            } catch (error) {
                log(`‚ùå Failed to enable local mode: ${error.message}`);
                updateStatus(`Error enabling local mode: ${error.message}`, 'error');
            }
        }
        
        async function testSyncSystem() {
            try {
                updateStatus('Testing sync system...', 'info');
                
                if (window.SyncManager) {
                    const stats = window.SyncManager.getStats();
                    log(`üìä Sync stats: ${stats.queueLength} queued, ${stats.successRate}% success rate`);
                    
                    if (stats.queueLength > 0) {
                        log('‚ö†Ô∏è Clearing sync queue to prevent conflicts...');
                        await window.SyncManager.clearSyncQueue();
                    }
                }
                
                updateStatus('Sync system tested and cleared', 'success');
                updateProgress(5);
                
            } catch (error) {
                log(`‚ùå Failed to test sync system: ${error.message}`);
                updateStatus(`Error testing sync: ${error.message}`, 'error');
            }
        }
        
        async function testEventsLoading() {
            try {
                updateStatus('Testing events loading...', 'info');
                await waitForStorage();
                
                // Test getting all events
                const allEvents = await window.StorageManager.getAllEvents();
                log(`üìÖ Found ${allEvents.length} total events`);
                
                // Test getting current scannable event
                const currentEvent = await window.StorageManager.getCurrentScannableEvent();
                if (currentEvent) {
                    log(`üéØ Current scannable event: ${currentEvent.eventName}`);
                    if (currentEvent.scanningContext) {
                        log(`   Context: ${currentEvent.scanningContext.displayMessage}`);
                    }
                } else {
                    log('‚ùå No current scannable event found');
                }
                
                // Test scanning status
                if (window.StorageManager.isScanningAllowed) {
                    const scanningAllowed = await window.StorageManager.isScanningAllowed();
                    log(`üîç Scanning allowed: ${scanningAllowed ? 'Yes' : 'No'}`);
                }
                
                if (allEvents.length > 0 && currentEvent) {
                    updateStatus('‚úÖ Events loading test PASSED - Fix successful!', 'success');
                } else {
                    updateStatus('‚ùå Events loading test FAILED - Need more troubleshooting', 'error');
                }
                
                updateProgress(6);
                
            } catch (error) {
                log(`‚ùå Events loading test failed: ${error.message}`);
                updateStatus(`Test failed: ${error.message}`, 'error');
            }
        }
        
        function openMainApp() {
            log('üöÄ Opening main application...');
            window.open('index.html', '_blank');
        }
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                log('üîß Fix tool initializing...');
                updateStatus('Initializing fix tool...', 'info');
                
                await waitForStorage();
                
                // Check current state
                const events = await window.StorageManager.getAllEvents();
                log(`üìä Current state: ${events.length} events in database`);
                
                if (events.length === 0) {
                    updateStatus('‚ö†Ô∏è No events found - this is the issue! Use the buttons above to fix it.', 'warning');
                } else {
                    updateStatus(`Found ${events.length} events - checking if they\'re accessible...`, 'info');
                    
                    const currentEvent = await window.StorageManager.getCurrentScannableEvent();
                    if (currentEvent) {
                        updateStatus('‚úÖ Events are loading properly - issue may be resolved!', 'success');
                    } else {
                        updateStatus('‚ö†Ô∏è Events exist but none are scannable - may need today\'s event', 'warning');
                    }
                }
                
                log('üéâ Fix tool ready!');
                
            } catch (error) {
                log(`‚ùå Initialization failed: ${error.message}`);
                updateStatus(`Initialization failed: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>