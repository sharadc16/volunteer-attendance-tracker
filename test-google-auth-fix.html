<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Auth & Events Display Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .btn {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.success {
            background: #28a745;
        }

        .btn.warning {
            background: #ffc107;
            color: #212529;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        .info {
            color: blue;
        }

        .warning {
            color: orange;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .status-card {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>üîß Google Auth & Events Display Fix</h1>

    <div class="section">
        <h3>üîê Authentication Status</h3>
        <button class="btn" onclick="checkAuthStatus()">Check Auth Status</button>
        <button class="btn warning" onclick="forceReAuth()">Force Re-Authentication</button>
        <button class="btn success" onclick="testConnection()">Test Connection</button>
        <button class="btn" onclick="checkPermissions()">Check Write Permissions</button>
        <button class="btn warning" onclick="fixPermissions()">Fix Permissions</button>
        <button class="btn success" onclick="testAuthPersistence()">Test Auth Persistence</button>
        <button class="btn" onclick="smartAuth()">Smart Auth (No Popup)</button>
        <button class="btn warning" onclick="checkAuthInProgress()">Check Auth In Progress</button>
        <div id="authResults"></div>
    </div>

    <div class="section">
        <h3>üìä Events Display Debug</h3>
        <button class="btn" onclick="checkEventsInDB()">Check Events in Database</button>
        <button class="btn" onclick="checkEventsView()">Check Events View Element</button>
        <button class="btn success" onclick="forceEventsRefresh()">Force Events Refresh</button>
        <div id="eventsResults"></div>
    </div>

    <div class="section">
        <h3>üîÑ Sync Status</h3>
        <button class="btn" onclick="checkSyncStatus()">Check Sync Status</button>
        <button class="btn" onclick="forceSyncFromSheets()">Force Sync from Sheets</button>
        <button class="btn warning" onclick="clearSyncData()">Clear Sync Data</button>
        <div id="syncResults"></div>
    </div>

    <div class="section">
        <h3>üß™ Quick Tests</h3>
        <div class="status-grid">
            <div class="status-card">
                <h4>Storage Manager</h4>
                <div id="storageStatus">Checking...</div>
            </div>
            <div class="status-card">
                <h4>Google Sheets Service</h4>
                <div id="googleStatus">Checking...</div>
            </div>
            <div class="status-card">
                <h4>App Instance</h4>
                <div id="appStatus">Checking...</div>
            </div>
            <div class="status-card">
                <h4>Events View</h4>
                <div id="viewStatus">Checking...</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>üöÄ Quick Actions</h3>
        <button class="btn" onclick="openMainApp()">Open Main App</button>
        <button class="btn" onclick="goToEventsView()">Go to Events View</button>
        <button class="btn danger" onclick="resetAuth()">Reset All Auth Data</button>
    </div>

    <script>
        function log(message, type = 'info') {
            console.log(message);
        }

        function updateResults(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="${type}">${content}</div>`;
            }
        }

        async function checkAuthStatus() {
            try {
                updateResults('authResults', 'Checking authentication status...', 'info');

                if (typeof window.checkGoogleAuth === 'function') {
                    const status = window.checkGoogleAuth();
                    updateResults('authResults', `
                        <strong>Authentication Status:</strong><br>
                        <pre>${JSON.stringify(status, null, 2)}</pre>
                    `, status?.isAuthenticated ? 'success' : 'warning');
                } else {
                    updateResults('authResults', 'checkGoogleAuth function not available', 'error');
                }

            } catch (error) {
                updateResults('authResults', `Error: ${error.message}`, 'error');
            }
        }

        async function forceReAuth() {
            try {
                updateResults('authResults', 'Forcing re-authentication...', 'info');

                if (typeof window.forceGoogleReAuth === 'function') {
                    const success = await window.forceGoogleReAuth();
                    updateResults('authResults', success ? 'Re-authentication successful!' : 'Re-authentication failed', success ? 'success' : 'error');
                } else {
                    updateResults('authResults', 'forceGoogleReAuth function not available', 'error');
                }

            } catch (error) {
                updateResults('authResults', `Error: ${error.message}`, 'error');
            }
        }

        async function testConnection() {
            try {
                updateResults('authResults', 'Testing Google Sheets connection...', 'info');

                if (typeof window.testGoogleSheetsConnection === 'function') {
                    const success = await window.testGoogleSheetsConnection();
                    updateResults('authResults', success ? 'Connection test successful!' : 'Connection test failed', success ? 'success' : 'error');
                } else {
                    updateResults('authResults', 'testGoogleSheetsConnection function not available', 'error');
                }

            } catch (error) {
                updateResults('authResults', `Error: ${error.message}`, 'error');
            }
        }

        async function checkEventsInDB() {
            try {
                updateResults('eventsResults', 'Checking events in database...', 'info');

                if (window.StorageManager) {
                    const events = await window.StorageManager.getAllEvents();
                    updateResults('eventsResults', `
                        <strong>Events in Database: ${events.length}</strong><br>
                        <pre>${JSON.stringify(events.slice(0, 2), null, 2)}</pre>
                        ${events.length > 2 ? `<p>... and ${events.length - 2} more events</p>` : ''}
                    `, 'success');
                } else {
                    updateResults('eventsResults', 'StorageManager not available', 'error');
                }

            } catch (error) {
                updateResults('eventsResults', `Error: ${error.message}`, 'error');
            }
        }

        async function checkEventsView() {
            try {
                updateResults('eventsResults', 'Checking events view element...', 'info');

                const app = window.opener?.app || parent.app || window.app;
                const eventsList = document.getElementById('eventsList') ||
                    (window.opener && window.opener.document.getElementById('eventsList')) ||
                    (parent.document && parent.document.getElementById('eventsList'));

                let results = [];
                results.push(`App instance: ${app ? 'Found' : 'Not found'}`);
                results.push(`Current view: ${app?.currentView || 'Unknown'}`);
                results.push(`Events list element: ${eventsList ? 'Found' : 'Not found'}`);

                if (eventsList) {
                    results.push(`Content length: ${eventsList.innerHTML.length} characters`);
                    results.push(`Preview: ${eventsList.innerHTML.substring(0, 100)}...`);
                }

                updateResults('eventsResults', results.join('<br>'), eventsList ? 'success' : 'warning');

            } catch (error) {
                updateResults('eventsResults', `Error: ${error.message}`, 'error');
            }
        }

        async function forceEventsRefresh() {
            try {
                updateResults('eventsResults', 'Forcing events refresh...', 'info');

                if (typeof window.refreshEventsView === 'function') {
                    await window.refreshEventsView();
                    updateResults('eventsResults', 'Events view refresh triggered', 'success');
                } else {
                    updateResults('eventsResults', 'refreshEventsView function not available', 'error');
                }

            } catch (error) {
                updateResults('eventsResults', `Error: ${error.message}`, 'error');
            }
        }

        async function checkSyncStatus() {
            try {
                updateResults('syncResults', 'Checking sync status...', 'info');

                if (typeof window.checkSyncStatus === 'function') {
                    const status = window.checkSyncStatus();
                    updateResults('syncResults', `
                        <strong>Sync Status:</strong><br>
                        <pre>${JSON.stringify(status, null, 2)}</pre>
                    `, 'success');
                } else {
                    updateResults('syncResults', 'checkSyncStatus function not available', 'error');
                }

            } catch (error) {
                updateResults('syncResults', `Error: ${error.message}`, 'error');
            }
        }

        async function forceSyncFromSheets() {
            try {
                updateResults('syncResults', 'Forcing sync from Google Sheets...', 'info');

                if (typeof window.forceSyncFromSheets === 'function') {
                    const success = await window.forceSyncFromSheets();
                    updateResults('syncResults', success ? 'Sync completed successfully!' : 'Sync failed', success ? 'success' : 'error');
                } else {
                    updateResults('syncResults', 'forceSyncFromSheets function not available', 'error');
                }

            } catch (error) {
                updateResults('syncResults', `Error: ${error.message}`, 'error');
            }
        }

        async function clearSyncData() {
            try {
                updateResults('syncResults', 'Clearing sync data...', 'info');

                localStorage.removeItem('lastGoogleSheetsSync');
                localStorage.removeItem('googleSheetsToken');

                updateResults('syncResults', 'Sync data cleared. Next sync will be forced.', 'success');

            } catch (error) {
                updateResults('syncResults', `Error: ${error.message}`, 'error');
            }
        }

        async function checkPermissions() {
            try {
                updateResults('authResults', 'Checking write permissions...', 'info');

                if (typeof window.checkGoogleSheetsPermissions === 'function') {
                    const hasPermissions = await window.checkGoogleSheetsPermissions();
                    updateResults('authResults', hasPermissions ? 'Write permissions confirmed!' : 'No write permissions - need to fix', hasPermissions ? 'success' : 'error');
                } else {
                    updateResults('authResults', 'checkGoogleSheetsPermissions function not available', 'error');
                }

            } catch (error) {
                updateResults('authResults', `Error: ${error.message}`, 'error');
            }
        }

        async function fixPermissions() {
            try {
                updateResults('authResults', 'Attempting to fix permissions...', 'info');

                if (typeof window.fixGoogleSheetsPermissions === 'function') {
                    const fixed = await window.fixGoogleSheetsPermissions();
                    updateResults('authResults', fixed ? 'Permissions fixed successfully!' : 'Could not fix permissions - check console for details', fixed ? 'success' : 'error');
                } else {
                    updateResults('authResults', 'fixGoogleSheetsPermissions function not available', 'error');
                }

            } catch (error) {
                updateResults('authResults', `Error: ${error.message}`, 'error');
            }
        }

        async function testAuthPersistence() {
            try {
                updateResults('authResults', 'Testing authentication persistence...', 'info');

                if (typeof window.testAuthPersistence === 'function') {
                    const status = window.testAuthPersistence();
                    const statusText = status === true ? 'Valid' :
                        status === 'needs_refresh' ? 'Needs Refresh' : 'Invalid';
                    updateResults('authResults', `Authentication persistence: ${statusText}`,
                        status === true ? 'success' : status === 'needs_refresh' ? 'warning' : 'error');
                } else {
                    updateResults('authResults', 'testAuthPersistence function not available', 'error');
                }

            } catch (error) {
                updateResults('authResults', `Error: ${error.message}`, 'error');
            }
        }

        async function smartAuth() {
            try {
                updateResults('authResults', 'Attempting smart authentication (no popup if token valid)...', 'info');

                if (typeof window.smartAuth === 'function') {
                    const success = await window.smartAuth();
                    updateResults('authResults', success ? 'Smart authentication successful!' : 'Smart authentication failed', success ? 'success' : 'error');
                } else {
                    updateResults('authResults', 'smartAuth function not available', 'error');
                }

            } catch (error) {
                updateResults('authResults', `Error: ${error.message}`, 'error');
            }
        }

        async function checkAuthInProgress() {
            try {
                updateResults('authResults', 'Checking if authentication is in progress...', 'info');

                if (typeof window.checkAuthInProgress === 'function') {
                    const inProgress = window.checkAuthInProgress();
                    updateResults('authResults', `Authentication in progress: ${inProgress}`, inProgress ? 'warning' : 'success');
                } else {
                    updateResults('authResults', 'checkAuthInProgress function not available', 'error');
                }

            } catch (error) {
                updateResults('authResults', `Error: ${error.message}`, 'error');
            }
        }

        async function resetAuth() {
            try {
                if (confirm('This will clear all authentication data. Continue?')) {
                    localStorage.removeItem('googleSheetsCredentials');
                    localStorage.removeItem('googleSheetsCredentials_development');
                    localStorage.removeItem('googleSheetsCredentials_production');
                    localStorage.removeItem('googleSheetsToken');
                    localStorage.removeItem('lastGoogleSheetsSync');

                    if (window.GoogleSheetsService) {
                        window.GoogleSheetsService.isAuthenticated = false;
                        window.GoogleSheetsService.accessToken = null;
                    }

                    alert('Authentication data cleared. Please refresh the page.');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function openMainApp() {
            if (window.opener) {
                window.opener.focus();
            } else {
                window.open('../index.html', '_blank');
            }
        }

        function goToEventsView() {
            const app = window.opener?.app || parent.app;
            if (app) {
                app.showView('events');
                if (window.opener) {
                    window.opener.focus();
                }
            } else {
                openMainApp();
            }
        }

        // Auto-check status when page loads
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(async () => {
                // Check Storage Manager
                const storageStatus = window.StorageManager ? 'Available ‚úÖ' : 'Not Available ‚ùå';
                document.getElementById('storageStatus').innerHTML = storageStatus;

                // Check Google Sheets Service
                const googleStatus = window.GoogleSheetsService ? 'Available ‚úÖ' : 'Not Available ‚ùå';
                document.getElementById('googleStatus').innerHTML = googleStatus;

                // Check App Instance
                const app = window.opener?.app || parent.app || window.app;
                const appStatus = app ? `Available ‚úÖ (View: ${app.currentView})` : 'Not Available ‚ùå';
                document.getElementById('appStatus').innerHTML = appStatus;

                // Check Events View Element
                const eventsList = document.getElementById('eventsList') ||
                    (window.opener && window.opener.document.getElementById('eventsList')) ||
                    (parent.document && parent.document.getElementById('eventsList'));
                const viewStatus = eventsList ? 'Found ‚úÖ' : 'Not Found ‚ùå';
                document.getElementById('viewStatus').innerHTML = viewStatus;

                // Auto-run some checks
                checkAuthStatus();
                checkEventsInDB();
            }, 1000);
        });
    </script>
</body>

</html>