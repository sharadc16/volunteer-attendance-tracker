<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Volunteer Sync Optimization</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .test-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-buttons { margin: 10px 0; }
        .test-buttons button { margin: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .config-display { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 Test Volunteer Sync Optimization</h1>
        
        <div class="test-section">
            <h2>1. Current Configuration</h2>
            <div class="test-buttons">
                <button onclick="showCurrentConfig()">Show Config</button>
                <button onclick="toggleVolunteerSync()">Toggle Volunteer Sync</button>
                <button onclick="setCustomInterval()">Set Custom Interval</button>
                <button onclick="resetNotFoundCounter()">Reset Not Found Counter</button>
            </div>
            <div id="configDisplay" class="config-display">
                Loading configuration...
            </div>
        </div>
        
        <div class="test-section">
            <h2>2. Manual Volunteer Sync</h2>
            <div class="test-buttons">
                <button onclick="testManualVolunteerSync()">Test Manual Volunteer Sync</button>
                <button onclick="testForceVolunteerSync()">Test Force Volunteer Sync</button>
            </div>
            <div id="manualSyncStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>3. Automatic Sync Testing</h2>
            <div class="test-buttons">
                <button onclick="testPeriodicSync()">Test Periodic Sync (Should Block)</button>
                <button onclick="testHighPrioritySync()">Test High Priority Sync</button>
                <button onclick="simulateLocalVolunteerChange()">Simulate Local Volunteer Change</button>
                <button onclick="simulateVolunteerNotFound()">Simulate Volunteer Not Found</button>
            </div>
            <div id="automaticSyncStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>4. "Not Found" Sync Testing</h2>
            <div class="test-buttons">
                <button onclick="testNotFoundSyncLimits()">Test Not Found Sync Limits</button>
                <button onclick="simulateMultipleNotFound()">Simulate Multiple Not Found (5x)</button>
            </div>
            <div id="notFoundTestResults"></div>
        </div>
        
        <div class="test-section">
            <h2>5. Frequency Test</h2>
            <div class="test-buttons">
                <button onclick="runVolunteerFrequencyTest()">Run Frequency Test (10 attempts)</button>
                <button onclick="resetSyncTimer()">Reset Sync Timer</button>
            </div>
            <div id="frequencyTestResults"></div>
        </div>
        
        <div class="test-section">
            <h2>6. Console Log Monitor</h2>
            <div class="test-buttons">
                <button onclick="clearLog()">Clear Log</button>
                <button onclick="toggleLogMonitoring()">Toggle Log Monitoring</button>
            </div>
            <div id="consoleLog" class="log">
                Console messages will appear here...
            </div>
        </div>
    </div>

    <!-- Include necessary scripts -->
    <script src="js/environment-manager.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/google-sheets.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/connectivity-validator.js"></script>
    <script src="js/scanner.js"></script>
    <script src="js/app.js"></script>
    <script src="optimize-volunteer-sync.js"></script>

    <script>
        let logMonitoring = true;
        let consoleMessages = [];
        
        // Capture console messages
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        function captureConsoleMessage(level, args) {
            const message = args.join(' ');
            const timestamp = new Date().toLocaleTimeString();
            
            consoleMessages.push({
                timestamp,
                level,
                message
            });
            
            // Keep only last 50 messages
            if (consoleMessages.length > 50) {
                consoleMessages = consoleMessages.slice(-50);
            }
            
            if (logMonitoring) {
                updateConsoleLog();
            }
        }
        
        console.log = function(...args) {
            captureConsoleMessage('log', args);
            originalConsoleLog.apply(console, args);
        };
        
        console.warn = function(...args) {
            captureConsoleMessage('warn', args);
            originalConsoleWarn.apply(console, args);
        };
        
        console.error = function(...args) {
            captureConsoleMessage('error', args);
            originalConsoleError.apply(console, args);
        };
        
        function updateConsoleLog() {
            const logDiv = document.getElementById('consoleLog');
            if (logDiv && logMonitoring) {
                const relevantMessages = consoleMessages.filter(msg => 
                    msg.message.includes('Volunteer sync') || 
                    msg.message.includes('volunteer sync') ||
                    msg.message.includes('syncVolunteers') ||
                    msg.message.includes('🔄') ||
                    msg.message.includes('🛑') ||
                    msg.message.includes('✅') ||
                    msg.message.includes('volunteer')
                );
                
                const html = relevantMessages.slice(-20).map(msg => 
                    `<div class="${msg.level}">[${msg.timestamp}] ${msg.message}</div>`
                ).join('');
                
                logDiv.innerHTML = html || 'No relevant messages captured yet...';
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }
        
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }
        
        function showCurrentConfig() {
            const configDiv = document.getElementById('configDisplay');
            
            if (typeof window.getVolunteerSyncConfig === 'function') {
                const config = window.getVolunteerSyncConfig();
                const timeSinceLastSync = Math.floor(config.timeSinceLastSync / 1000);
                const timeSinceLastNotFound = Math.floor(config.timeSinceLastNotFoundSync / 1000);
                
                configDiv.innerHTML = `
                    <h4>Volunteer Sync Configuration</h4>
                    <ul>
                        <li><strong>Periodic Sync Disabled:</strong> ${config.disablePeriodicVolunteerSync}</li>
                        <li><strong>Allowed Triggers:</strong> ${config.allowedVolunteerSyncTriggers.join(', ')}</li>
                        <li><strong>Min Interval:</strong> ${config.minVolunteerSyncInterval / 1000} seconds</li>
                        <li><strong>Last Sync:</strong> ${timeSinceLastSync} seconds ago</li>
                        <li><strong>"Not Found" Syncs:</strong> ${config.volunteerNotFoundSyncs}/${config.maxVolunteerNotFoundSyncs}</li>
                        <li><strong>Last "Not Found" Sync:</strong> ${timeSinceLastNotFound} seconds ago</li>
                    </ul>
                `;
            } else {
                configDiv.innerHTML = '<div class="status error">Volunteer sync configuration not available</div>';
            }
        }
        
        function toggleVolunteerSync() {
            if (typeof window.setVolunteerSyncEnabled === 'function') {
                const config = window.getVolunteerSyncConfig();
                const newState = config.disablePeriodicVolunteerSync; // Toggle
                window.setVolunteerSyncEnabled(newState);
                
                setTimeout(showCurrentConfig, 100);
                showStatus('configDisplay', `Volunteer sync ${newState ? 'enabled' : 'disabled'}`, 'success');
            } else {
                showStatus('configDisplay', 'Volunteer sync toggle not available', 'error');
            }
        }
        
        function setCustomInterval() {
            const seconds = prompt('Enter minimum sync interval in seconds:', '600');
            if (seconds && !isNaN(seconds)) {
                if (typeof window.setVolunteerSyncInterval === 'function') {
                    window.setVolunteerSyncInterval(parseInt(seconds));
                    setTimeout(showCurrentConfig, 100);
                    showStatus('configDisplay', `Interval set to ${seconds} seconds`, 'success');
                } else {
                    showStatus('configDisplay', 'Interval setting not available', 'error');
                }
            }
        }
        
        function resetNotFoundCounter() {
            if (typeof window.resetVolunteerNotFoundCounter === 'function') {
                window.resetVolunteerNotFoundCounter();
                setTimeout(showCurrentConfig, 100);
                showStatus('configDisplay', 'Not found counter reset', 'success');
            } else {
                showStatus('configDisplay', 'Reset function not available', 'error');
            }
        }
        
        async function testManualVolunteerSync() {
            showStatus('manualSyncStatus', 'Testing manual volunteer sync...', 'info');
            
            try {
                if (typeof window.forceVolunteerSync === 'function') {
                    const result = await window.forceVolunteerSync();
                    showStatus('manualSyncStatus', `Manual volunteer sync completed: ${JSON.stringify(result)}`, 'success');
                } else {
                    showStatus('manualSyncStatus', 'Manual volunteer sync function not available', 'error');
                }
            } catch (error) {
                showStatus('manualSyncStatus', `Manual volunteer sync failed: ${error.message}`, 'error');
            }
        }
        
        async function testForceVolunteerSync() {
            showStatus('manualSyncStatus', 'Testing force volunteer sync via GoogleSheetsService...', 'info');
            
            try {
                if (window.GoogleSheetsService && window.GoogleSheetsService.syncVolunteersFromSheets) {
                    const result = await window.GoogleSheetsService.syncVolunteersFromSheets('manual-force-sync');
                    showStatus('manualSyncStatus', `Force volunteer sync completed: ${JSON.stringify(result)}`, 'success');
                } else {
                    showStatus('manualSyncStatus', 'GoogleSheetsService volunteer sync not available', 'error');
                }
            } catch (error) {
                showStatus('manualSyncStatus', `Force volunteer sync failed: ${error.message}`, 'error');
            }
        }
        
        async function testPeriodicSync() {
            showStatus('automaticSyncStatus', 'Testing periodic sync (should be blocked)...', 'info');
            
            try {
                if (window.SyncManager && window.SyncManager.queueForSync) {
                    const result = await window.SyncManager.queueForSync('update', 'volunteers', { test: true }, 'normal');
                    
                    if (result === 'blocked') {
                        showStatus('automaticSyncStatus', '✅ Periodic sync correctly blocked', 'success');
                    } else {
                        showStatus('automaticSyncStatus', '⚠️ Periodic sync was not blocked', 'error');
                    }
                } else {
                    showStatus('automaticSyncStatus', 'SyncManager not available', 'error');
                }
            } catch (error) {
                showStatus('automaticSyncStatus', `Periodic sync test failed: ${error.message}`, 'error');
            }
        }
        
        async function testHighPrioritySync() {
            showStatus('automaticSyncStatus', 'Testing high priority sync (should be allowed)...', 'info');
            
            try {
                if (window.SyncManager && window.SyncManager.queueForSync) {
                    const result = await window.SyncManager.queueForSync('update', 'volunteers', { test: true }, 'high');
                    
                    if (result && result !== 'blocked') {
                        showStatus('automaticSyncStatus', '✅ High priority sync correctly allowed', 'success');
                    } else {
                        showStatus('automaticSyncStatus', '⚠️ High priority sync was blocked', 'error');
                    }
                } else {
                    showStatus('automaticSyncStatus', 'SyncManager not available', 'error');
                }
            } catch (error) {
                showStatus('automaticSyncStatus', `High priority sync test failed: ${error.message}`, 'error');
            }
        }
        
        function simulateLocalVolunteerChange() {
            showStatus('automaticSyncStatus', 'Simulating local volunteer change...', 'info');
            
            if (window.GoogleSheetsService && window.GoogleSheetsService.syncVolunteersFromSheets) {
                window.GoogleSheetsService.syncVolunteersFromSheets('local-volunteer-modified')
                    .then((result) => {
                        showStatus('automaticSyncStatus', `✅ Local volunteer change sync completed: ${JSON.stringify(result)}`, 'success');
                    })
                    .catch(error => {
                        showStatus('automaticSyncStatus', `Local volunteer change sync failed: ${error.message}`, 'error');
                    });
            } else {
                showStatus('automaticSyncStatus', 'GoogleSheetsService not available', 'error');
            }
        }
        
        function simulateVolunteerNotFound() {
            showStatus('automaticSyncStatus', 'Simulating volunteer not found scenario...', 'info');
            
            const testVolunteerId = 'TEST' + Date.now();
            
            if (window.GoogleSheetsService && window.GoogleSheetsService.syncVolunteersFromSheets) {
                window.GoogleSheetsService.syncVolunteersFromSheets('volunteer-not-found', testVolunteerId)
                    .then((result) => {
                        showStatus('automaticSyncStatus', `✅ Volunteer not found sync completed: ${JSON.stringify(result)}`, 'success');
                        setTimeout(showCurrentConfig, 100);
                    })
                    .catch(error => {
                        showStatus('automaticSyncStatus', `Volunteer not found sync failed: ${error.message}`, 'error');
                    });
            } else {
                showStatus('automaticSyncStatus', 'GoogleSheetsService not available', 'error');
            }
        }
        
        async function testNotFoundSyncLimits() {
            showStatus('notFoundTestResults', 'Testing not found sync limits...', 'info');
            
            const results = [];
            
            for (let i = 0; i < 5; i++) {
                const testVolunteerId = `TEST${Date.now()}_${i}`;
                
                try {
                    if (window.GoogleSheetsService && window.GoogleSheetsService.syncVolunteersFromSheets) {
                        const result = await window.GoogleSheetsService.syncVolunteersFromSheets('volunteer-not-found', testVolunteerId);
                        results.push({
                            attempt: i + 1,
                            volunteerId: testVolunteerId,
                            result: result,
                            blocked: result && result.reason === 'blocked-by-optimization'
                        });
                    }
                } catch (error) {
                    results.push({
                        attempt: i + 1,
                        volunteerId: testVolunteerId,
                        error: error.message,
                        blocked: false
                    });
                }
                
                // Small delay between attempts
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            const blockedCount = results.filter(r => r.blocked).length;
            const allowedCount = results.filter(r => !r.blocked && !r.error).length;
            const errorCount = results.filter(r => r.error).length;
            
            const resultHtml = `
                <div class="status info">
                    <strong>Not Found Sync Limits Test:</strong><br>
                    Total attempts: 5<br>
                    Blocked: ${blockedCount}<br>
                    Allowed: ${allowedCount}<br>
                    Errors: ${errorCount}<br>
                    <br>
                    <strong>Expected:</strong> First 3 should be allowed, rest blocked.
                </div>
                <details>
                    <summary>Detailed Results</summary>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                </details>
            `;
            
            document.getElementById('notFoundTestResults').innerHTML = resultHtml;
            setTimeout(showCurrentConfig, 100);
        }
        
        async function simulateMultipleNotFound() {
            showStatus('notFoundTestResults', 'Simulating multiple not found scenarios...', 'info');
            
            for (let i = 0; i < 5; i++) {
                const testVolunteerId = `MULTI_TEST${Date.now()}_${i}`;
                simulateVolunteerNotFound();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            setTimeout(() => {
                showStatus('notFoundTestResults', 'Multiple not found simulation completed', 'success');
                showCurrentConfig();
            }, 3000);
        }
        
        async function runVolunteerFrequencyTest() {
            showStatus('frequencyTestResults', 'Running volunteer frequency test (10 attempts)...', 'info');
            
            const results = [];
            const startTime = Date.now();
            
            for (let i = 0; i < 10; i++) {
                try {
                    const attemptStart = Date.now();
                    
                    if (window.SyncManager && window.SyncManager.queueForSync) {
                        const result = await window.SyncManager.queueForSync('update', 'volunteers', { test: i }, 'normal');
                        results.push({
                            attempt: i + 1,
                            result: result,
                            blocked: result === 'blocked',
                            time: Date.now() - attemptStart
                        });
                    }
                    
                    // Small delay between attempts
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    results.push({
                        attempt: i + 1,
                        result: 'error',
                        error: error.message,
                        blocked: false,
                        time: 0
                    });
                }
            }
            
            const totalTime = Date.now() - startTime;
            const blockedCount = results.filter(r => r.blocked).length;
            const allowedCount = results.filter(r => !r.blocked && r.result !== 'error').length;
            const errorCount = results.filter(r => r.result === 'error').length;
            
            const resultHtml = `
                <div class="status info">
                    <strong>Volunteer Frequency Test Results:</strong><br>
                    Total attempts: 10<br>
                    Blocked: ${blockedCount}<br>
                    Allowed: ${allowedCount}<br>
                    Errors: ${errorCount}<br>
                    Total time: ${totalTime}ms<br>
                    <br>
                    <strong>Expected:</strong> Most attempts should be blocked due to frequency limits.
                </div>
                <details>
                    <summary>Detailed Results</summary>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                </details>
            `;
            
            document.getElementById('frequencyTestResults').innerHTML = resultHtml;
        }
        
        function resetSyncTimer() {
            if (typeof window.getVolunteerSyncConfig === 'function') {
                const config = window.getVolunteerSyncConfig();
                config.lastVolunteerSyncTime = 0;
                showStatus('frequencyTestResults', 'Volunteer sync timer reset - next sync will be allowed', 'success');
                setTimeout(showCurrentConfig, 100);
            } else {
                showStatus('frequencyTestResults', 'Cannot reset sync timer - config not available', 'error');
            }
        }
        
        function clearLog() {
            consoleMessages = [];
            updateConsoleLog();
        }
        
        function toggleLogMonitoring() {
            logMonitoring = !logMonitoring;
            const button = event.target;
            button.textContent = logMonitoring ? 'Disable Log Monitoring' : 'Enable Log Monitoring';
            
            if (logMonitoring) {
                updateConsoleLog();
            } else {
                document.getElementById('consoleLog').innerHTML = 'Log monitoring disabled';
            }
        }
        
        // Auto-update config display
        setInterval(showCurrentConfig, 5000);
        
        // Initial setup
        window.addEventListener('load', () => {
            setTimeout(() => {
                showCurrentConfig();
                updateConsoleLog();
            }, 1000);
        });
        
        console.log('🧪 Volunteer sync optimization test page loaded');
    </script>
</body>
</html>