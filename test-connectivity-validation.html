<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connectivity Validation Test - Volunteer Attendance Tracker</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .test-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        
        .test-section h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .test-results {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
        
        .test-button {
            margin: 0.5rem 0.5rem 0.5rem 0;
            padding: 0.5rem 1rem;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-button.secondary {
            background: #6c757d;
        }
        
        .test-button.secondary:hover {
            background: #545b62;
        }
        
        .status-demo {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #2c3e50;
            color: white;
            border-radius: 6px;
        }
        
        .log-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 1rem;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ” Connectivity Validation System Test</h1>
        <p>This page tests the connectivity validation and system readiness checking functionality.</p>
        
        <!-- Status Demo Section -->
        <div class="test-section">
            <h3>ğŸ“Š Live Status Display</h3>
            <p>This shows the actual connectivity status indicators as they would appear in the main application:</p>
            
            <div class="status-demo">
                <div id="connectivityStatus">
                    <!-- Status indicators will be inserted here -->
                </div>
            </div>
            
            <div class="scanner-status-container">
                <div class="scanner-status" id="scannerStatus">
                    <span class="scanner-indicator unknown"></span>
                    <span class="scanner-text">Initializing...</span>
                </div>
                <div class="sync-status-compact" id="syncStatus">
                    <span class="sync-status-indicator offline"></span>
                    <span class="sync-status-text">Sync</span>
                </div>
            </div>
        </div>
        
        <!-- Manual Testing Section -->
        <div class="test-section">
            <h3>ğŸ§ª Manual Tests</h3>
            <p>Click these buttons to test different aspects of the connectivity validation system:</p>
            
            <button class="test-button" onclick="testFullValidation()">ğŸ” Run Full Validation</button>
            <button class="test-button" onclick="testLocalStorage()">ğŸ’¾ Test Local Storage</button>
            <button class="test-button" onclick="testGoogleSheets()">ğŸ“Š Test Google Sheets</button>
            <button class="test-button" onclick="showDetailedStatus()">ğŸ“‹ Show Detailed Status</button>
            <button class="test-button secondary" onclick="simulateOffline()">ğŸŒ Simulate Offline</button>
            <button class="test-button secondary" onclick="simulateOnline()">ğŸŒ Simulate Online</button>
            <button class="test-button secondary" onclick="clearTestResults()">ğŸ§¹ Clear Results</button>
            
            <div id="testResults" class="test-results"></div>
        </div>
        
        <!-- Real-time Monitoring Test -->
        <div class="test-section">
            <h3>â±ï¸ Real-time Monitoring Test</h3>
            <p>Test the real-time connectivity monitoring during scanning sessions:</p>
            
            <button class="test-button" onclick="startMonitoring()">â–¶ï¸ Start Monitoring</button>
            <button class="test-button" onclick="stopMonitoring()">â¹ï¸ Stop Monitoring</button>
            <button class="test-button secondary" onclick="simulateConnectivityIssue()">âš ï¸ Simulate Issue</button>
            
            <div id="monitoringResults" class="test-results"></div>
        </div>
        
        <!-- System Integration Test -->
        <div class="test-section">
            <h3>ğŸ”— System Integration Test</h3>
            <p>Test integration with scanner and other system components:</p>
            
            <button class="test-button" onclick="testScannerIntegration()">ğŸ“± Test Scanner Integration</button>
            <button class="test-button" onclick="testStatusChangeEvents()">ğŸ“¡ Test Status Events</button>
            <button class="test-button" onclick="testRepairFunctionality()">ğŸ”§ Test Repair Functions</button>
            
            <div id="integrationResults" class="test-results"></div>
        </div>
        
        <!-- Console Log Output -->
        <div class="test-section">
            <h3>ğŸ“ Console Log Output</h3>
            <p>Real-time console output from the connectivity validation system:</p>
            <div id="logOutput" class="log-output"></div>
            <button class="test-button secondary" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/google-sheets.js"></script>
    <script src="js/connectivity-validator.js"></script>

    <script>
        // Test functions
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;
        
        // Capture console output
        function setupConsoleCapture() {
            const logOutput = document.getElementById('logOutput');
            
            function addLogEntry(type, args) {
                const timestamp = new Date().toLocaleTimeString();
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');
                
                const logEntry = document.createElement('div');
                logEntry.style.color = type === 'error' ? '#ff6b6b' : 
                                     type === 'warn' ? '#ffd93d' : '#00ff00';
                logEntry.textContent = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
                
                logOutput.appendChild(logEntry);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
            
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                addLogEntry('log', args);
            };
            
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                addLogEntry('error', args);
            };
            
            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                addLogEntry('warn', args);
            };
        }
        
        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '';
        }
        
        function addTestResult(sectionId, message) {
            const section = document.getElementById(sectionId);
            const timestamp = new Date().toLocaleTimeString();
            section.textContent += `[${timestamp}] ${message}\n`;
        }
        
        function clearTestResults() {
            document.getElementById('testResults').textContent = '';
        }
        
        // Test functions
        async function testFullValidation() {
            addTestResult('testResults', 'Starting full validation test...');
            
            if (!window.connectivityValidator) {
                addTestResult('testResults', 'ERROR: Connectivity validator not available');
                return;
            }
            
            try {
                await window.connectivityValidator.performFullValidation();
                const results = window.connectivityValidator.getValidationResults();
                addTestResult('testResults', `Full validation completed: ${JSON.stringify(results, null, 2)}`);
            } catch (error) {
                addTestResult('testResults', `Full validation failed: ${error.message}`);
            }
        }
        
        async function testLocalStorage() {
            addTestResult('testResults', 'Testing local storage validation...');
            
            if (!window.connectivityValidator) {
                addTestResult('testResults', 'ERROR: Connectivity validator not available');
                return;
            }
            
            try {
                const result = await window.connectivityValidator.validateLocalStorage();
                addTestResult('testResults', `Local storage test: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                addTestResult('testResults', `Local storage test failed: ${error.message}`);
            }
        }
        
        async function testGoogleSheets() {
            addTestResult('testResults', 'Testing Google Sheets connectivity...');
            
            if (!window.connectivityValidator) {
                addTestResult('testResults', 'ERROR: Connectivity validator not available');
                return;
            }
            
            try {
                const result = await window.connectivityValidator.validateGoogleSheetsConnectivity();
                addTestResult('testResults', `Google Sheets test: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                addTestResult('testResults', `Google Sheets test failed: ${error.message}`);
            }
        }
        
        function showDetailedStatus() {
            if (window.connectivityValidator) {
                window.connectivityValidator.showDetailedStatus();
            } else {
                addTestResult('testResults', 'ERROR: Connectivity validator not available');
            }
        }
        
        function simulateOffline() {
            addTestResult('testResults', 'Simulating offline state...');
            window.dispatchEvent(new Event('offline'));
        }
        
        function simulateOnline() {
            addTestResult('testResults', 'Simulating online state...');
            window.dispatchEvent(new Event('online'));
        }
        
        function startMonitoring() {
            addTestResult('monitoringResults', 'Starting real-time monitoring...');
            
            if (window.connectivityValidator) {
                window.connectivityValidator.startRealTimeMonitoring();
                addTestResult('monitoringResults', 'Real-time monitoring started');
            } else {
                addTestResult('monitoringResults', 'ERROR: Connectivity validator not available');
            }
        }
        
        function stopMonitoring() {
            addTestResult('monitoringResults', 'Stopping real-time monitoring...');
            
            if (window.connectivityValidator) {
                window.connectivityValidator.stopRealTimeMonitoring();
                addTestResult('monitoringResults', 'Real-time monitoring stopped');
            } else {
                addTestResult('monitoringResults', 'ERROR: Connectivity validator not available');
            }
        }
        
        function simulateConnectivityIssue() {
            addTestResult('monitoringResults', 'Simulating connectivity issue...');
            
            // Simulate a temporary connectivity problem
            if (window.connectivityValidator) {
                window.connectivityValidator.updateOverallStatus('error', false, 'Simulated connectivity issue');
                window.connectivityValidator.updateStatusIndicators();
                
                // Restore after 5 seconds
                setTimeout(() => {
                    window.connectivityValidator.performFullValidation();
                    addTestResult('monitoringResults', 'Connectivity issue resolved (simulated)');
                }, 5000);
            }
        }
        
        function testScannerIntegration() {
            addTestResult('integrationResults', 'Testing scanner integration...');
            
            // Test scanner activation/deactivation events
            document.dispatchEvent(new CustomEvent('scannerActivated'));
            addTestResult('integrationResults', 'Scanner activated event dispatched');
            
            setTimeout(() => {
                document.dispatchEvent(new CustomEvent('scannerDeactivated'));
                addTestResult('integrationResults', 'Scanner deactivated event dispatched');
            }, 2000);
        }
        
        function testStatusChangeEvents() {
            addTestResult('integrationResults', 'Testing status change events...');
            
            if (window.connectivityValidator) {
                // Add a test listener
                const testListener = (results) => {
                    addTestResult('integrationResults', `Status change event received: ${results.overall.status}`);
                };
                
                window.connectivityValidator.addStatusChangeListener(testListener);
                
                // Trigger a status change
                window.connectivityValidator.performFullValidation();
                
                // Remove listener after test
                setTimeout(() => {
                    window.connectivityValidator.removeStatusChangeListener(testListener);
                    addTestResult('integrationResults', 'Test listener removed');
                }, 3000);
            }
        }
        
        async function testRepairFunctionality() {
            addTestResult('integrationResults', 'Testing repair functionality...');
            
            if (window.connectivityValidator) {
                try {
                    await window.connectivityValidator.attemptRepair();
                    addTestResult('integrationResults', 'Repair function completed');
                } catch (error) {
                    addTestResult('integrationResults', `Repair function failed: ${error.message}`);
                }
            }
        }
        
        // Initialize test environment
        function initializeTest() {
            setupConsoleCapture();
            
            // Wait for connectivity validator to initialize
            const checkValidator = () => {
                if (window.connectivityValidator && window.connectivityValidator.isInitialized) {
                    addTestResult('testResults', 'Connectivity validator initialized successfully');
                    
                    // Add status change listener for live updates
                    window.connectivityValidator.addStatusChangeListener((results) => {
                        console.log('Status change detected:', results);
                    });
                } else {
                    setTimeout(checkValidator, 100);
                }
            };
            
            checkValidator();
        }
        
        // Start test when page loads
        document.addEventListener('DOMContentLoaded', initializeTest);
    </script>
</body>
</html>